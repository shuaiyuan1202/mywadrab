<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#FDFCF9">
    <title>我的智能衣橱</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha1/0.6.0/sha1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #FDFCF9; -webkit-tap-highlight-color: transparent; }
        .font-serif-sc { font-family: 'Noto Serif SC', serif; }
        .glass-effect { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); }
        .card-shadow { box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05); }
        [v-cloak] { display: none; }
        .loading-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .loader-ring { border: 2px solid #f3f3f3; border-top: 2px solid #0f172a; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .zoom-fade-enter-active, .zoom-fade-leave-active { transition: opacity 0.3s ease, transform 0.3s ease; }
        .zoom-fade-enter-from, .zoom-fade-leave-to { opacity: 0; transform: scale(0.95); }
        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
    </style>
</head>
<body>
    <div id="app" v-cloak class="min-h-screen flex flex-col relative overflow-x-hidden text-slate-900">
        
        <!-- 全局加载/锁定遮罩 -->
        <div v-if="loading || isDeleting || isReplacing || isSaving" class="fixed inset-0 z-[120] bg-white/95 backdrop-blur-md flex flex-col items-center justify-center p-10">
            <div class="loader-ring mb-6"></div>
            <div class="text-center space-y-3">
                <p class="text-slate-900 font-serif-sc text-lg loading-pulse">{{ currentLoadingMessage }}</p>
                <p class="text-slate-400 text-[10px] tracking-[0.2em] uppercase font-bold">{{ currentLoadingSubMessage }}</p>
            </div>
        </div>

        <!-- 登录视图 -->
        <div v-if="!isLoggedIn" class="fixed inset-0 z-50 bg-[#FDFCF9] flex flex-col items-center justify-center p-8 animate-in fade-in">
            <div class="w-full max-w-sm space-y-8">
                <div class="text-center space-y-2">
                    <div class="w-16 h-16 bg-slate-900 rounded-2xl mx-auto flex items-center justify-center text-white mb-6 shadow-xl">
                        <span v-html="getIcon('shirt', 'w-8 h-8')"></span>
                    </div>
                    <h1 class="text-3xl font-serif-sc text-slate-900">智能衣橱</h1>
                    <p class="text-xs text-slate-400 uppercase tracking-widest">Digital Wardrobe Manager</p>
                </div>

                <div class="space-y-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">用户名</label>
                        <input v-model="loginForm.username" type="text" class="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 outline-none focus:border-slate-400 transition-colors">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">密码</label>
                        <input v-model="loginForm.password" type="password" class="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 outline-none focus:border-slate-400 transition-colors">
                    </div>
                    
                    <!-- 登录页也提供开发模式切换 -->
                    <div class="flex items-center justify-end">
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <span class="text-[10px] text-slate-400 group-hover:text-slate-600">本地调试</span>
                            <div class="relative inline-block w-8 h-4 transition duration-200 ease-in-out bg-slate-200 rounded-full" 
                                 :class="{'bg-green-400': isLocalDebug}">
                                <input type="checkbox" v-model="isLocalDebug" class="absolute w-full h-full opacity-0 cursor-pointer" />
                                <span class="absolute left-0 inline-block w-4 h-4 bg-white border border-slate-200 rounded-full shadow transition-transform duration-200 ease-in-out transform" 
                                      :class="{'translate-x-4': isLocalDebug}"></span>
                            </div>
                        </label>
                    </div>

                    <button @click="handleLogin" :disabled="loading" class="w-full py-4 bg-slate-900 text-white rounded-xl font-bold text-sm shadow-xl active:scale-95 transition-all mt-4">
                        {{ loading ? '验证中...' : '登录' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- 主应用界面 (仅登录后显示) -->
        <template v-else>
            <!-- 顶部导航 -->
            <header class="sticky top-0 z-30 glass-effect border-b border-slate-100 px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <h1 class="text-xl font-serif-sc text-slate-900">我的衣橱</h1>
                    <!-- 视图切换 -->
                    <div class="flex bg-slate-100 p-1 rounded-lg">
                        <button @click="changeViewMode('card')" :class="[viewMode === 'card' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-400']" class="p-1.5 rounded-md transition-all"><span v-html="getIcon('layout-grid', 'w-3.5 h-3.5')"></span></button>
                        <button @click="changeViewMode('list')" :class="[viewMode === 'list' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-400']" class="p-1.5 rounded-md transition-all"><span v-html="getIcon('list', 'w-3.5 h-3.5')"></span></button>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <!-- 模型切换 -->
                    <div class="hidden sm:flex items-center gap-2 bg-slate-100 p-1 rounded-lg">
                        <button @click="currentModel = 'gemini-2.5-flash-preview-09-2025'" 
                                :class="[currentModel === 'gemini-2.5-flash-preview-09-2025' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-400']"
                                class="px-2 py-1 text-[10px] font-bold rounded transition-all">Flash</button>
                        <button @click="currentModel = 'gemini-2.5-flash-lite'" 
                                :class="[currentModel === 'gemini-2.5-flash-lite' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-400']"
                                class="px-2 py-1 text-[10px] font-bold rounded transition-all">Lite</button>
                    </div>

                    <div class="flex items-center gap-1.5 px-2 py-1 rounded-full bg-slate-50 border border-slate-100">
                        <div class="w-2 h-2 rounded-full bg-green-500"></div>
                        <span class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter truncate max-w-[60px]">{{ currentUser?.name }}</span>
                    </div>
                    
                    <!-- 优化后的退出登录按钮 -->
                    <button @click="handleLogout" class="flex items-center gap-1.5 px-3 py-1.5 bg-red-50 hover:bg-red-100 text-red-500 rounded-full transition-all group">
                        <span class="text-[10px] font-bold group-hover:underline">退出</span>
                        <span v-html="getIcon('log-out', 'w-3.5 h-3.5')"></span>
                    </button>
                </div>
            </header>

            <!-- 首页列表 -->
            <main v-if="currentView === 'home'" class="flex-1 p-6 pb-32 animate-in fade-in">
                <!-- 初始 Loading 状态 -->
                <div v-if="initialLoading" class="flex flex-col items-center justify-center py-32 space-y-4 animate-pulse">
                    <div class="w-16 h-16 bg-slate-100 rounded-full"></div>
                    <div class="w-32 h-4 bg-slate-100 rounded-full"></div>
                    <p class="text-xs text-slate-300">正在同步衣橱数据...</p>
                </div>

                <!-- 空状态 (仅当非 Loading 且无数据时显示) -->
                <div v-else-if="wardrobe.length === 0" class="flex flex-col items-center justify-center py-24 text-slate-300">
                    <div class="p-6 bg-white rounded-full shadow-inner mb-6"><span v-html="getIcon('shirt', 'w-12 h-12 opacity-20')"></span></div>
                    <p class="text-slate-500 font-medium">您的衣橱是空的</p>
                </div>
                
                <!-- 列表内容 -->
                <div v-else :class="[viewMode === 'card' ? 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4' : 'flex flex-col gap-3']">
                    <div v-for="item in wardrobe" :key="item.id" @click="showDetail(item)"
                         :class="[viewMode === 'card' ? 'flex-col' : 'flex-row items-center p-2 gap-4']"
                         class="group bg-white rounded-2xl overflow-hidden card-shadow border border-slate-50 cursor-pointer active:scale-95 transition-all flex">
                        <div :class="[viewMode === 'card' ? 'aspect-[3/4] w-full' : 'w-16 h-16 rounded-xl shrink-0']" class="bg-slate-100 relative overflow-hidden">
                            <img :src="viewMode === 'list' ? getThumbnail(item.itemImage) : item.itemImage" class="w-full h-full object-cover">
                        </div>
                        <div class="p-3 text-left flex-1 min-w-0">
                            <h3 class="font-medium text-slate-800 truncate text-sm">{{ item.name }}</h3>
                            <p class="text-[10px] text-slate-400 mt-1 uppercase truncate">{{ item.analysis?.composition_summary || '已存入' }}</p>
                        </div>
                    </div>
                </div>
            </main>

            <!-- 新增录入视图 -->
            <main v-if="currentView === 'add'" class="flex-1 p-6 animate-in slide-in-from-bottom-4">
                <div class="max-w-xl mx-auto space-y-6 text-left">
                    <div @click="goHome" class="flex items-center gap-2 cursor-pointer text-slate-400 hover:text-slate-600 transition-colors">
                        <span v-html="getIcon('chevron-left', 'w-5 h-5')"></span>
                        <span class="text-sm font-medium">返回衣橱</span>
                    </div>
                    <h2 class="text-2xl font-serif-sc">添加新衣服分析</h2>
                    <div class="space-y-4">
                        <input v-model="newItem.name" type="text" placeholder="衣服名称（如：米色羊毛西装）" class="w-full bg-white border border-slate-200 rounded-2xl px-5 py-4 outline-none focus:border-slate-300 transition-colors shadow-sm">
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">全身展示照片</label>
                            <div @click="triggerFile('itemImage')" class="aspect-[16/10] bg-white border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center overflow-hidden cursor-pointer hover:border-slate-300 transition-colors bg-white">
                                <img v-if="newItem.itemImage" :src="newItem.itemImage" class="w-full h-full object-cover">
                                <span v-else v-html="getIcon('camera', 'w-8 h-8 text-slate-200')"></span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">洗水标/面料细节</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div v-for="(img, idx) in newItem.labelImages" :key="idx" class="aspect-square rounded-2xl overflow-hidden relative shadow-sm">
                                    <img :src="img" class="w-full h-full object-cover">
                                    <button @click="newItem.labelImages.splice(idx,1)" class="absolute top-1 right-1 bg-black/50 text-white rounded-full p-1"><span v-html="getIcon('x', 'w-3 h-3')"></span></button>
                                </div>
                                <div v-if="newItem.labelImages.length < 2" @click="triggerFile('labelImage')" class="aspect-square border-2 border-dashed border-slate-200 rounded-2xl flex items-center justify-center cursor-pointer hover:border-slate-300 transition-colors bg-white">
                                    <span v-html="getIcon('plus', 'w-5 h-5 text-slate-200')"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <input type="file" ref="itemImageInput" hidden accept="image/*" @change="handleFile($event, 'itemImage')">
                    <input type="file" ref="labelImageInput" hidden accept="image/*" @change="handleFile($event, 'labelImage')">
                    <button @click="startAnalysis" :disabled="!isReadyToAnalyze || loading" class="w-full py-5 rounded-2xl font-bold bg-slate-900 text-white disabled:bg-slate-200 transition-all shadow-lg shadow-slate-200 active:scale-95">启动智能分析</button>
                </div>
            </main>

            <!-- 详情弹窗 -->
            <div v-if="showResultModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-0 sm:p-6">
                <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="closeResult"></div>
                <div class="relative w-full max-w-2xl bg-white rounded-t-[32px] sm:rounded-[32px] shadow-2xl max-h-[90vh] overflow-y-auto">
                    <!-- 根据 modalMode 判断显示内容 -->
                    <div v-if="modalMode === 'view'" class="relative aspect-[16/9] cursor-pointer group" @click="isDetailZoomed = true">
                        <img :src="selectedItem.itemImage" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent pointer-events-none"></div>
                        <div class="absolute bottom-6 left-8 text-white">
                             <p class="text-[10px] font-bold uppercase tracking-widest opacity-60 mb-1">Garment Archive</p>
                             <h3 class="text-2xl font-serif-sc">{{ selectedItem.name }}</h3>
                        </div>
                    </div>
                    <!-- 新录入模式 (create) -->
                    <div v-else class="relative aspect-[16/9] bg-slate-100">
                        <img :src="selectedItem.itemImage" class="w-full h-full object-cover">
                         <div class="absolute bottom-6 left-8 text-white z-10">
                             <h3 class="text-2xl font-serif-sc drop-shadow-md">{{ selectedItem.name }}</h3>
                        </div>
                         <div class="absolute inset-0 bg-gradient-to-t from-black/30 to-transparent pointer-events-none"></div>
                    </div>

                    <div class="p-8 space-y-6 text-left">
                        <div v-if="modalMode === 'create'" class="flex justify-between items-start">
                            <h3 class="text-2xl font-serif-sc text-slate-900">识别结果</h3>
                            <button @click="closeResult"><span v-html="getIcon('x', 'w-6 h-6 text-slate-300')"></span></button>
                        </div>

                        <div v-if="currentAnalysis" class="space-y-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">面料成分</label>
                                <div class="flex flex-wrap gap-2">
                                    <template v-for="(item, idx) in parsedComposition" :key="idx">
                                        <div class="flex items-center gap-2 px-3 py-2 bg-slate-50 border border-slate-100 rounded-xl">
                                            <span class="text-xs font-bold text-slate-700">{{ item.name }}</span>
                                            <span class="text-xs text-amber-600 bg-amber-50 px-1.5 py-0.5 rounded font-mono font-bold">{{ item.percentage }}</span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-2">洗涤建议</label>
                                    <p class="text-sm text-slate-600 leading-relaxed">{{ currentAnalysis.laundry_guide }}</p>
                                </div>
                                <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-2">干燥/熨烫</label>
                                    <p class="text-sm text-slate-600 leading-relaxed">{{ currentAnalysis.drying_guide || '自然晾干' }} / {{ currentAnalysis.iron_guide || '低温熨烫' }}</p>
                                </div>
                            </div>
                            <div class="p-6 bg-slate-900 rounded-2xl relative overflow-hidden shadow-xl">
                                <div class="absolute -right-4 -top-4 opacity-10 text-white transform rotate-12">
                                    <span v-html="getIcon('sparkles', 'w-24 h-24')"></span>
                                </div>
                                <label class="text-[10px] font-bold text-amber-400/60 uppercase block mb-2 tracking-widest">面料洞察</label>
                                <p class="text-sm text-amber-100 leading-relaxed italic relative z-10 font-medium tracking-wide">{{ currentAnalysis.fabric_insight }}</p>
                            </div>
                        </div>
                        
                        <!-- 底部按钮区：严格区分 create 和 view 模式 -->
                        <div v-if="modalMode === 'create'" class="flex gap-4 pt-4">
                            <button @click="closeResult" class="flex-1 py-4 bg-slate-50 rounded-2xl font-bold text-slate-400 hover:bg-slate-100 transition-colors">暂不保存</button>
                            <button @click="saveToWardrobe" :disabled="isSaving" class="flex-1 py-4 bg-slate-900 text-white rounded-2xl font-bold shadow-xl active:scale-95 transition-all">
                                {{ isSaving ? '同步中...' : '确认入库' }}
                            </button>
                        </div>
                        <div v-else class="pt-4 flex flex-col items-center gap-4">
                            <button @click="deleteItem" :disabled="isDeleting" class="text-red-400 text-xs font-bold flex items-center gap-2 p-4 hover:opacity-70 transition-opacity">
                                <span v-html="getIcon('trash-2', 'w-4 h-4')"></span> 移除此衣物记录
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 全屏细节 & 替换 -->
            <transition name="zoom-fade">
                <div v-if="isDetailZoomed && selectedItem" class="fixed inset-0 z-[120] bg-black flex flex-col" @click.self="isDetailZoomed = false">
                    <div class="flex justify-between items-center p-6 bg-gradient-to-b from-black/60 to-transparent pointer-events-none">
                        <button @click="isDetailZoomed = false" class="text-white/60 hover:text-white transition-colors pointer-events-auto">
                            <span v-html="getIcon('chevron-left', 'w-6 h-6')"></span>
                        </button>
                        <div class="text-white/40 text-[10px] font-bold uppercase tracking-widest">Detail View</div>
                        <div class="w-6"></div>
                    </div>
                    
                    <div class="flex-1 flex items-center justify-center p-4 pointer-events-none">
                        <img :src="selectedItem.itemImage" class="max-w-full max-h-full object-contain rounded-xl shadow-2xl">
                    </div>

                    <div class="p-8 pb-12 flex justify-center bg-gradient-to-t from-black/60 to-transparent">
                        <button @click="triggerReplaceCover" class="px-8 py-4 bg-white/10 backdrop-blur-md border border-white/20 text-white rounded-full font-bold text-sm flex items-center gap-3 active:scale-95 transition-all shadow-xl pointer-events-auto">
                            <span v-html="getIcon('image-plus', 'w-4 h-4')"></span>
                            替换当前封面图
                        </button>
                    </div>
                    <input type="file" ref="replaceCoverInput" hidden accept="image/*" @change="handleReplaceCover">
                </div>
            </transition>

            <!-- 设置弹窗 (用于切换调试模式) -->
            <div v-if="showSettings" class="fixed inset-0 z-50 flex items-center justify-center p-6">
                <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="showSettings = false"></div>
                <div class="relative w-full max-w-sm bg-white rounded-[24px] p-6 shadow-2xl overflow-y-auto max-h-[85vh]">
                    <h3 class="font-bold text-slate-900 mb-4">系统设置</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                            <span class="text-xs font-medium text-slate-600">本地调试 (localhost:3000)</span>
                            <div class="relative inline-block w-8 h-4 transition duration-200 ease-in-out bg-slate-200 rounded-full" 
                                 :class="{'bg-green-400': isLocalDebug}">
                                <input type="checkbox" v-model="isLocalDebug" class="absolute w-full h-full opacity-0 cursor-pointer" />
                                <span class="absolute left-0 inline-block w-4 h-4 bg-white border border-slate-200 rounded-full shadow transition-transform duration-200 ease-in-out transform" 
                                      :class="{'translate-x-4': isLocalDebug}"></span>
                            </div>
                        </div>
                        <p class="text-[10px] text-slate-400 leading-relaxed">
                            开启后将请求 http://localhost:3000/api/feishu。<br>
                            请确保本地已运行 `vercel dev`。
                        </p>
                    </div>
                </div>
            </div>

            <!-- 底部新增按钮 -->
            <footer v-if="currentView === 'home'" class="fixed bottom-0 left-0 right-0 p-8 flex justify-center z-20 pointer-events-none">
                <button @click="goAdd" class="bg-slate-900 text-white px-8 py-4 rounded-full flex items-center gap-3 shadow-[0_20px_50px_rgba(0,0,0,0.3)] active:scale-95 transition-all pointer-events-auto border border-white/10">
                    <span v-html="getIcon('plus-circle', 'w-5 h-5')"></span>
                    <span class="font-bold tracking-wide">添加新衣物分析</span>
                </button>
            </footer>
        </template>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

        createApp({
            setup() {
                // --- 状态 ---
                const isLoggedIn = ref(false);
                const currentUser = ref(null);
                const loginForm = ref({ username: '', password: '' });
                const initialLoading = ref(false); 
                
                // 环境判断与调试模式
                const isLocalHost = ['localhost', '127.0.0.1'].includes(window.location.hostname);
                const isLocalDebug = ref(isLocalHost); 
                
                const wardrobe = ref([]);
                const currentView = ref('home');
                const viewMode = ref(localStorage.getItem('wardrobe_view_mode') || 'card');
                const loading = ref(false);
                const isSaving = ref(false);
                const isDeleting = ref(false);
                const isReplacing = ref(false);
                const showResultModal = ref(false);
                const isDetailZoomed = ref(false);
                const showSettings = ref(false);
                const currentModel = ref('gemini-2.5-flash-lite');
                
                // 配置
                const config = ref({
                    clCloudName: '', clApiKey: '', clApiSecret: '', clUploadPreset: '',
                    geminiKey: '',
                    fsAppToken: 'SR2gbXdS5aMnsVsDWOPc0nixnDg',
                    fsTableId: 'tblanETFV7K3nptS'
                });

                const currentVercelUrl = computed(() => {
                    return isLocalDebug.value 
                        ? 'http://localhost:3000/api/feishu' 
                        : 'https://mywadrab.vercel.app/api/feishu';
                });

                const currentLoadingMessage = ref('初始化中...');
                const currentLoadingSubMessage = ref('INITIALIZING');
                let messageTimer = null;

                // 替换 isNewItem，使用更明确的 modalMode 状态：'create' 或 'view'
                const modalMode = ref('view'); 
                const newItem = ref({ name: '', itemImage: null, labelImages: [] });
                const selectedItem = ref(null);
                const currentAnalysis = ref(null);
                
                const itemImageInput = ref(null);
                const labelImageInput = ref(null);
                const replaceCoverInput = ref(null);

                // --- 登录系统 ---
                
                onMounted(() => {
                    checkLoginStatus();
                    nextTick(() => window.lucide?.createIcons());
                });

                const checkLoginStatus = () => {
                    const cookie = document.cookie.split('; ').find(row => row.startsWith('wardrobe_user='));
                    if (cookie) {
                        try {
                            const userData = JSON.parse(decodeURIComponent(cookie.split('=')[1]));
                            currentUser.value = userData;
                            applyUserConfig(userData.config);
                            isLoggedIn.value = true;
                            syncFromFeishu(userData.user_id, true);
                        } catch (e) {
                            console.error("Cookie Parse Error", e);
                        }
                    }
                };

                const handleLogin = async () => {
                    loading.value = true;
                    currentLoadingMessage.value = "正在验证身份...";
                    currentLoadingSubMessage.value = "AUTHENTICATING";

                    try {
                        const targetUrl = new URL(currentVercelUrl.value);
                        targetUrl.searchParams.set('action', 'login');

                        const res = await fetch(targetUrl.toString(), {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                app_token: config.value.fsAppToken, 
                                table_id: config.value.fsTableId,   
                                username: loginForm.value.username,
                                password: loginForm.value.password
                            })
                        });

                        const data = await res.json();
                        if (data.code === 0) {
                            const user = data.data;
                            currentUser.value = user;
                            applyUserConfig(user.config);
                            
                            const d = new Date();
                            d.setTime(d.getTime() + (7*24*60*60*1000));
                            document.cookie = `wardrobe_user=${encodeURIComponent(JSON.stringify(user))};expires=${d.toUTCString()};path=/`;
                            
                            isLoggedIn.value = true;
                            syncFromFeishu(user.user_id, true);
                        } else {
                            alert(data.msg || "登录失败");
                        }
                    } catch (e) {
                        alert(`登录请求出错: ${e.message}\n(当前接口: ${currentVercelUrl.value})`);
                    } finally {
                        loading.value = false;
                    }
                };

                const handleLogout = () => {
                    document.cookie = "wardrobe_user=; max-age=0; path=/";
                    isLoggedIn.value = false;
                    currentUser.value = null;
                    wardrobe.value = [];
                };

                const applyUserConfig = (userConfig) => {
                    config.value = {
                        ...config.value,
                        clCloudName: userConfig.cl_cloud_name,
                        clApiKey: userConfig.cl_api_key,
                        clApiSecret: userConfig.cl_api_secret,
                        clUploadPreset: userConfig.cl_upload_preset,
                        geminiKey: userConfig.gemini_api_key,
                        clothesAppToken: userConfig.fs_app_token, 
                        clothesTableId: userConfig.fs_table_id 
                    };
                };

                // --- 业务逻辑 ---

                const callVercelProxy = async (action, payload = {}) => {
                    const body = {
                        app_token: config.value.clothesAppToken, // 使用衣服表的配置
                        table_id: config.value.clothesTableId,
                        ...payload
                    };
                    const targetUrl = new URL(currentVercelUrl.value);
                    targetUrl.searchParams.set('action', action);
                    const res = await fetch(targetUrl.toString(), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    const data = await res.json();
                    if (data.code !== 0) throw new Error(data.msg || 'API Error');
                    return data;
                };

                const syncFromFeishu = async (userId, isInit = false, silent = false) => {
                    if (!userId) return;
                    
                    if (!silent) {
                        if (isInit) initialLoading.value = true;
                        else {
                            loading.value = true;
                            currentLoadingMessage.value = "正在同步您的衣橱...";
                            currentLoadingSubMessage.value = "SYNCING DATA";
                        }
                    }
                    
                    try {
                        const filter = `CurrentValue.[user_id]="${userId}"`;
                        const targetUrl = new URL(currentVercelUrl.value);
                        targetUrl.searchParams.set('action', 'list_records');
                        
                        const res = await fetch(targetUrl.toString(), {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                app_token: config.value.clothesAppToken,
                                table_id: config.value.clothesTableId,
                                filter: filter
                            })
                        });
                        const data = await res.json();

                        if (data.code === 0 && data.data) {
                            const rawItems = data.data.items || [];
                            const items = rawItems.map(record => ({
                                record_id: record.record_id, 
                                id: record.fields.uuid || record.record_id,
                                name: record.fields.name,
                                itemImage: record.fields.image_url, 
                                publicId: record.fields.public_id,
                                analysis: record.fields.analysis ? JSON.parse(record.fields.analysis) : null,
                                createdAt: record.fields.created_at || Date.now()
                            }));
                            wardrobe.value = items.sort((a, b) => b.createdAt - a.createdAt);
                            localStorage.setItem('my_smart_wardrobe_data', JSON.stringify(wardrobe.value));
                        }
                    } catch (e) {
                        console.error(e);
                    } finally {
                        if (!silent) {
                            if (isInit) initialLoading.value = false;
                            else loading.value = false;
                        }
                    }
                };

                // --- 通用 ---
                const getIcon = (name, cls) => {
                    // 安全检查：增加 try-catch 防止图标库报错中断 Vue 渲染
                    try {
                        if (window.lucide && window.lucide.icons && window.lucide.icons[name]) {
                            return window.lucide.icons[name].toSvg({ class: cls || 'w-5 h-5' });
                        }
                    } catch (e) {
                        console.warn('Icon render failed:', name);
                    }
                    return ''; 
                };
                
                const getThumbnail = (url) => url?.replace('/upload/', '/upload/w_200,h_200,c_fill,q_auto/') || url;
                const changeViewMode = (m) => { viewMode.value = m; localStorage.setItem('wardrobe_view_mode', m); nextTick(() => window.lucide?.createIcons()); };
                const goHome = () => { currentView.value = 'home'; modalMode.value = 'view'; nextTick(() => window.lucide?.createIcons()); };
                const goAdd = () => { currentView.value = 'add'; nextTick(() => window.lucide?.createIcons()); };
                const triggerFile = (type) => (type === 'itemImage' ? itemImageInput : labelImageInput).value.click();
                const closeResult = () => { 
                    if(!loading.value && !isSaving.value) { 
                        showResultModal.value = false; 
                        selectedItem.value = null; 
                    } 
                };

                const showDetail = (item) => {
                    selectedItem.value = item;
                    currentAnalysis.value = item.analysis;
                    modalMode.value = 'view'; // 明确设置为查看模式
                    showResultModal.value = true;
                    nextTick(() => window.lucide?.createIcons());
                }

                const handleFile = (e, type) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        const img = new Image();
                        img.src = evt.target.result;
                        img.onload = () => {
                            const cvs = document.createElement('canvas');
                            let w = img.width, h = img.height, max = 1200;
                            if (w > max) { h = (max/w)*h; w = max; }
                            cvs.width = w; cvs.height = h;
                            cvs.getContext('2d').drawImage(img,0,0,w,h);
                            const b64 = cvs.toDataURL('image/jpeg', 0.88);
                            if (type === 'itemImage') newItem.value.itemImage = b64;
                            else newItem.value.labelImages.push(b64);
                        };
                    };
                    reader.readAsDataURL(file);
                };

                const analyzeMessages = [
                    { title: "正在识别水洗标中的面料成分...", sub: "Fiber Recognition" },
                    { title: "正在基于面料成分评估洗护注意事项...", sub: "Care Assessment" },
                    { title: "正在通过织物特性构建面料管理洞察...", sub: "Insight Generation" },
                    { title: "正在为您同步数字衣橱档案...", subtitle: "Archive Syncing" }
                ];

                const startAnalysis = async () => {
                    loading.value = true;
                    let msgIdx = 0;
                    currentLoadingMessage.value = analyzeMessages[0].title;
                    currentLoadingSubMessage.value = analyzeMessages[0].sub;
                    const timer = setInterval(() => {
                        msgIdx = (msgIdx + 1) % analyzeMessages.length;
                        currentLoadingMessage.value = analyzeMessages[msgIdx].title;
                        currentLoadingSubMessage.value = analyzeMessages[msgIdx].sub;
                    }, 2200);

                    try {
                        const b64s = newItem.value.labelImages.map(i => i.split(',')[1]);
                        const payload = {
                            contents: [{ parts: [{ text: "分析衣服..." }, ...b64s.map(b => ({ inlineData: { mimeType: "image/jpeg", data: b } }))] }],
                            systemInstruction: { parts: [{ text: `你是一位资深的面料与衣物护理专家。请根据图片分析衣物，并输出严格的 JSON 格式数据。
**关键要求**：
1. **语言必须强制使用简体中文**（品牌名称可保留英文）。
2. **composition**（面料成分）：必须是数组格式，例如 [{"name": "棉", "percentage": "100%"}, {"name": "聚酯纤维", "percentage": "20%"}]。
3. **fabric_insight**（面料洞察）：根据成分分析其特性（如：吸湿透气、抗皱、需要小心起球、不可暴晒等），给出专业的面料特性分析，不要只重复列出成分。
4. **laundry_guide**（洗护建议）：将洗涤图标或常识转化为通俗易懂的操作建议（如：务必冷水手洗，不可机洗）。
5. **drying_guide**（干燥建议）和 **iron_guide**（熨烫建议）：给出具体建议。

JSON 结构：
{
  "composition": [{"name": "string", "percentage": "string"}],
  "composition_summary": "string",
  "laundry_guide": "string",
  "drying_guide": "string",
  "iron_guide": "string",
  "fabric_insight": "string"
}` }] },
                            generationConfig: { responseMimeType: "application/json" }
                        };
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/${currentModel.value}:generateContent?key=${config.value.geminiKey}`;
                        const geminiRes = await fetch(url, { method: 'POST', body: JSON.stringify(payload) });
                        const geminiData = await geminiRes.json();
                        
                        let text = geminiData.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (!text) throw new Error("API Returned Empty Response");
                        
                        const jsonMatch = text.match(/\{[\s\S]*\}/);
                        const jsonStr = jsonMatch ? jsonMatch[0] : text;
                        
                        const analysisResult = JSON.parse(jsonStr);
                        currentAnalysis.value = analysisResult;

                        // 设置预览数据
                        selectedItem.value = {
                            name: newItem.value.name,
                            itemImage: newItem.value.itemImage,
                            analysis: analysisResult
                        };
                        
                        // 关键修改：显式设置为创建模式，避免布尔值逻辑错误
                        modalMode.value = 'create'; 
                        showResultModal.value = true;
                        
                        // 确保图标重绘，防止界面卡顿
                        nextTick(() => window.lucide?.createIcons());

                    } catch (e) {
                        console.error("Analysis Error:", e);
                        alert("处理失败: " + e.message);
                    } finally {
                        clearInterval(timer);
                        loading.value = false;
                    }
                };

                const saveToWardrobe = async () => {
                    isSaving.value = true;
                    currentLoadingMessage.value = "正在同步云端档案...";
                    currentLoadingSubMessage.value = "Cloud Syncing";
                    
                    try {
                        const uploadRes = await uploadToCloudinary(newItem.value.itemImage);
                        
                        const itemData = {
                            name: newItem.value.name,
                            itemImage: uploadRes.url,
                            publicId: uploadRes.publicId,
                            analysis: currentAnalysis.value,
                            createdAt: Date.now(),
                            id: crypto.randomUUID()
                        };
                        
                        await callVercelProxy('add_record', {
                            fields: {
                                name: itemData.name,
                                image_url: itemData.itemImage,
                                public_id: itemData.publicId,
                                analysis: JSON.stringify(itemData.analysis),
                                created_at: itemData.createdAt,
                                uuid: itemData.id,
                                user_id: currentUser.value.user_id 
                            }
                        });

                        await syncFromFeishu(currentUser.value.user_id);
                        showResultModal.value = false;
                        goHome();
                        
                    } catch (e) {
                        alert("同步失败: " + e.message);
                    } finally {
                        isSaving.value = false;
                    }
                };

                const uploadToCloudinary = async (base64) => {
                    if (!config.value.clCloudName || !config.value.clUploadPreset) return { url: base64, publicId: null };
                    const formData = new FormData();
                    formData.append('file', base64);
                    formData.append('upload_preset', config.value.clUploadPreset);
                    try {
                        const res = await fetch(`https://api.cloudinary.com/v1_1/${config.value.clCloudName}/image/upload`, { method: 'POST', body: formData });
                        const data = await res.json();
                        return { url: data.secure_url, publicId: data.public_id };
                    } catch (e) { return { url: base64, publicId: null }; }
                };

                const deleteFromCloudinary = async (publicId) => {
                    if (!publicId || !config.value.clApiKey || !config.value.clApiSecret || !config.value.clCloudName) return false;
                    const timestamp = Math.round((new Date()).getTime() / 1000);
                    const stringToSign = `public_id=${publicId}&timestamp=${timestamp}${config.value.clApiSecret}`;
                    const signature = sha1(stringToSign);
                    const formData = new FormData();
                    formData.append('public_id', publicId);
                    formData.append('timestamp', timestamp);
                    formData.append('api_key', config.value.clApiKey);
                    formData.append('signature', signature);
                    try {
                        await fetch(`https://api.cloudinary.com/v1_1/${config.value.clCloudName}/image/destroy`, { method: 'POST', body: formData });
                        return true;
                    } catch (e) { return false; }
                };

                const handleReplaceCover = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    isReplacing.value = true;
                    currentLoadingMessage.value = "正在更新封面...";
                    
                    try {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        await new Promise(r => reader.onload = r);
                        
                        const form = new FormData();
                        form.append('file', reader.result);
                        form.append('upload_preset', config.value.clUploadPreset);
                        const clRes = await fetch(`https://api.cloudinary.com/v1_1/${config.value.clCloudName}/image/upload`, { method: 'POST', body: form });
                        const clData = await clRes.json();

                        if (selectedItem.value.record_id) {
                            await callVercelProxy('update_record', {
                                record_id: selectedItem.value.record_id,
                                fields: { image_url: clData.secure_url, public_id: clData.public_id }
                            });
                        }
                        
                        selectedItem.value.itemImage = clData.secure_url;
                        isDetailZoomed.value = false;
                        await syncFromFeishu(currentUser.value.user_id);
                    } catch(e) { alert("替换失败"); }
                    finally { isReplacing.value = false; }
                };

                const deleteItem = async () => {
                    if(!confirm("确定移除此记录并销毁云端图片吗？")) return;
                    isDeleting.value = true;
                    currentLoadingMessage.value = "正在销毁云端数据...";
                    currentLoadingSubMessage.value = "Cloud Purging";
                    const item = selectedItem.value;
                    try {
                        if (item.publicId && config.value.clApiKey && config.value.clApiSecret) {
                            await deleteFromCloudinary(item.publicId);
                        }
                        
                        if (selectedItem.value.record_id) {
                            await callVercelProxy('delete_record', { record_id: selectedItem.value.record_id });
                        }
                        await syncFromFeishu(currentUser.value.user_id);
                        showResultModal.value = false;
                    } catch(e) { 
                        console.error(e);
                        alert("删除失败"); 
                    }
                    finally { isDeleting.value = false; }
                };

                const parsedComposition = computed(() => {
                    if (!currentAnalysis.value || !currentAnalysis.value.composition) return [];
                    const raw = currentAnalysis.value.composition;
                    
                    if (Array.isArray(raw)) {
                        return raw.map(item => {
                            if (typeof item === 'object' && item.name && item.percentage) return item;
                            if (typeof item === 'string') {
                                const parts = item.split(/[:：]/);
                                return { name: parts[0]?.trim(), percentage: parts[1]?.trim() || '' };
                            }
                            return { name: JSON.stringify(item), percentage: '' };
                        });
                    }
                    
                    if (typeof raw === 'object') {
                        return Object.entries(raw).map(([k, v]) => ({ name: k, percentage: v }));
                    }
                    
                    if (typeof raw === 'string') {
                        return raw.split(/[,，;；\n]/).map(s => {
                            const parts = s.split(/[:：]/);
                            return { name: parts[0]?.trim(), percentage: parts[1]?.trim() || '' };
                        }).filter(i => i.name);
                    }
                    
                    return [{ name: "成分", percentage: "见详情" }];
                });

                const isReadyToAnalyze = computed(() => newItem.value.name && newItem.value.itemImage && newItem.value.labelImages.length > 0);

                return {
                    isLoggedIn, currentUser, loginForm, isLocalDebug, initialLoading,
                    wardrobe, currentView, viewMode, currentModel,
                    loading, isSaving, isDeleting, isReplacing, currentLoadingMessage, currentLoadingSubMessage,
                    newItem, selectedItem, showResultModal, isDetailZoomed, currentAnalysis, parsedComposition, isReadyToAnalyze,
                    itemImageInput, labelImageInput, replaceCoverInput,
                    goHome, goAdd, getIcon, getThumbnail, changeViewMode, triggerFile, handleFile, startAnalysis, saveToWardrobe,
                    closeResult, deleteItem, triggerReplaceCover: () => replaceCoverInput.value.click(), handleReplaceCover,
                    handleLogin, handleLogout, showSettings, showDetail,
                    modalMode // 导出新状态
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#FDFCF9">
    <title>我的智能衣橱 - Cloudinary 增强版</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- 引入用于计算 Cloudinary 签名所需的 SHA-1 库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha1/0.6.0/sha1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #FDFCF9; -webkit-tap-highlight-color: transparent; }
        .font-serif-sc { font-family: 'Noto Serif SC', serif; }
        .glass-effect { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .card-shadow { box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05); }
        [v-cloak] { display: none; }
        .loading-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .loader-ring { border: 2px solid #f3f3f3; border-top: 2px solid #0f172a; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="app" v-cloak class="min-h-screen flex flex-col relative overflow-x-hidden">
        
        <!-- 全屏加载遮罩层 -->
        <div v-if="loading" class="fixed inset-0 z-[100] bg-white/90 backdrop-blur-md flex flex-col items-center justify-center p-10">
            <div class="loader-ring mb-6"></div>
            <div class="text-center space-y-3">
                <p class="text-slate-900 font-serif-sc text-lg loading-pulse">{{ currentLoadingMessage }}</p>
                <p class="text-slate-400 text-xs tracking-widest uppercase">Cloudinary & Gemini Processing</p>
            </div>
        </div>

        <!-- 页面顶部 -->
        <header class="sticky top-0 z-30 glass-effect border-b border-slate-100 px-6 py-4 flex justify-between items-center">
            <h1 class="text-xl font-serif-sc text-slate-900">我的衣橱</h1>
            <div class="flex items-center gap-3">
                <!-- Cloudinary 连接状态，点击可直接打开设置 -->
                <div @click="showSettings = true" class="flex items-center gap-1.5 px-2 py-1 rounded-full bg-slate-50 border border-slate-100 cursor-pointer hover:bg-slate-100 transition-colors">
                    <div class="w-2 h-2 rounded-full" 
                         :class="[isCloudConfigured ? 'bg-green-500' : 'bg-amber-400']">
                    </div>
                    <span class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">
                        {{ isCloudConfigured ? 'Cloudinary Ready' : 'Cloud Not Set' }}
                    </span>
                </div>
                
                <button @click="showSettings = true" class="p-2 hover:bg-slate-100 rounded-full transition-colors text-slate-400">
                    <span v-html="getIcon('settings', 'w-5 h-5')"></span>
                </button>
            </div>
        </header>

        <!-- 设置弹窗 -->
        <div v-if="showSettings" class="fixed inset-0 z-50 flex items-center justify-center p-6">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="showSettings = false"></div>
            <div class="relative w-full max-w-sm bg-white rounded-[24px] p-6 shadow-2xl overflow-y-auto max-h-[85vh]">
                <h3 class="font-bold text-slate-900 mb-4 text-left">设置中心</h3>
                <div class="space-y-6">
                    <div class="space-y-1 text-left">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Gemini API Key</label>
                        <input v-model="tempApiKey" type="password" placeholder="粘贴您的 API Key" 
                               class="w-full bg-slate-50 border border-slate-100 rounded-xl px-4 py-3 text-sm outline-none">
                    </div>

                    <div class="border-t border-slate-100 pt-4 text-left">
                        <h4 class="text-xs font-bold text-slate-900 mb-3">Cloudinary 配置</h4>
                        <div class="space-y-3">
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Cloud Name</label>
                                <input v-model="tempCloudName" type="text" placeholder="你的 Cloud Name" 
                                       class="w-full bg-slate-50 border border-slate-100 rounded-xl px-4 py-3 text-sm outline-none">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Upload Preset</label>
                                <input v-model="tempUploadPreset" type="text" placeholder="未签名的 Upload Preset" 
                                       class="w-full bg-slate-50 border border-slate-100 rounded-xl px-4 py-3 text-sm outline-none">
                            </div>
                            <!-- 新增：同步删除所需的私密配置 -->
                            <div class="p-3 bg-blue-50 rounded-xl mt-2">
                                <p class="text-[10px] text-blue-600 font-bold mb-2 uppercase tracking-tight">高级：启用云端同步删除</p>
                                <input v-model="tempClApiKey" type="text" placeholder="API Key" class="w-full bg-white border border-blue-100 rounded-lg px-3 py-2 text-[10px] mb-2 outline-none">
                                <input v-model="tempClApiSecret" type="password" placeholder="API Secret" class="w-full bg-white border border-blue-100 rounded-lg px-3 py-2 text-[10px] outline-none">
                            </div>
                        </div>
                    </div>

                    <button @click="saveSettings" class="w-full py-4 bg-slate-900 text-white rounded-xl font-bold text-sm shadow-lg active:scale-95 transition-all">保存设置</button>
                </div>
            </div>
        </div>

        <!-- 首页视图 -->
        <main v-if="currentView === 'home'" class="flex-1 p-6 pb-32 animate-in fade-in">
            <!-- 配置缺失引导：如果没配 Cloudinary，显著提示 -->
            <div v-if="!isCloudConfigured" class="mb-8 p-6 bg-amber-50 rounded-[24px] border border-amber-100 flex flex-col items-center text-center">
                <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center mb-4 text-amber-500">
                    <span v-html="getIcon('cloud-off', 'w-6 h-6')"></span>
                </div>
                <h3 class="text-sm font-bold text-amber-900 mb-1">Cloudinary 未配置</h3>
                <p class="text-[11px] text-amber-600/70 mb-4 leading-relaxed">如果不配置云存储，您的衣服图片将无法永久保存。请在设置中填写 Cloud Name 和 Upload Preset。</p>
                <button @click="showSettings = true" class="px-6 py-2.5 bg-amber-500 text-white text-[11px] font-bold rounded-full shadow-md shadow-amber-200 active:scale-95 transition-all">
                    立即去配置
                </button>
            </div>

            <!-- 无数据状态 -->
            <div v-if="wardrobe.length === 0" class="flex flex-col items-center justify-center py-24 text-slate-300">
                <div class="p-6 bg-white rounded-full shadow-inner mb-6">
                    <span v-html="getIcon('shirt', 'w-12 h-12 opacity-20')"></span>
                </div>
                <p class="text-slate-500 font-medium">衣橱目前是空的</p>
            </div>
            
            <!-- 数据列表 -->
            <div v-else class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <div v-for="item in wardrobe" :key="item.id" @click="showDetail(item)"
                     class="group bg-white rounded-2xl overflow-hidden card-shadow border border-slate-50 cursor-pointer active:scale-95 transition-all">
                    <div class="aspect-[3/4] bg-slate-100 relative overflow-hidden">
                        <img :src="item.itemImage" class="w-full h-full object-cover">
                    </div>
                    <div class="p-3 text-left">
                        <h3 class="font-medium text-slate-800 truncate text-sm">{{ item.name }}</h3>
                        <p class="text-[10px] text-slate-400 mt-1 uppercase">{{ item.analysis?.composition_summary || '已存入' }}</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- 新增识别视图 -->
        <main v-if="currentView === 'add'" class="flex-1 p-6 animate-in slide-in-from-bottom-4">
            <div class="max-w-xl mx-auto space-y-6 text-left">
                <div class="flex items-center gap-2 cursor-pointer" @click="goHome">
                    <span v-html="getIcon('chevron-left', 'w-5 h-5 text-slate-400')"></span>
                    <span class="text-slate-400 text-sm">返回衣橱</span>
                </div>
                <h2 class="text-2xl font-serif-sc">识别并存储</h2>
                <input v-model="newItem.name" type="text" placeholder="衣服名称（如：米色羊毛西装）" class="w-full bg-white border border-slate-200 rounded-2xl px-5 py-4 outline-none">
                
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">展示照片</label>
                    <div @click="triggerFile('itemImage')" class="aspect-video bg-white border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center overflow-hidden cursor-pointer">
                        <img v-if="newItem.itemImage" :src="newItem.itemImage" class="w-full h-full object-cover">
                        <span v-else v-html="getIcon('camera', 'w-8 h-8 text-slate-200')"></span>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">洗水标/面料详情 (AI 识别用)</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div v-for="(img, idx) in newItem.labelImages" :key="idx" class="aspect-square rounded-2xl overflow-hidden relative">
                            <img :src="img" class="w-full h-full object-cover">
                            <button @click="newItem.labelImages.splice(idx,1)" class="absolute top-1 right-1 bg-black/50 text-white rounded-full p-1"><span v-html="getIcon('x', 'w-3 h-3')"></span></button>
                        </div>
                        <div v-if="newItem.labelImages.length < 2" @click="triggerFile('labelImage')" class="aspect-square border-2 border-dashed border-slate-200 rounded-2xl flex items-center justify-center cursor-pointer">
                            <span v-html="getIcon('plus', 'w-5 h-5 text-slate-200')"></span>
                        </div>
                    </div>
                </div>

                <input type="file" ref="itemImageInput" hidden accept="image/*" @change="handleFile($event, 'itemImage')">
                <input type="file" ref="labelImageInput" hidden accept="image/*" @change="handleFile($event, 'labelImage')">
                
                <button @click="startAnalysis" :disabled="!isReadyToAnalyze || loading" class="w-full py-5 rounded-2xl font-bold bg-slate-900 text-white disabled:bg-slate-200 transition-all shadow-lg">开始 AI 分析</button>
            </div>
        </main>

        <!-- 识别结果/详情弹窗 -->
        <div v-if="showResultModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-0 sm:p-6">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="closeResult"></div>
            <div class="relative w-full max-w-2xl bg-white rounded-t-[32px] sm:rounded-[32px] shadow-2xl max-h-[90vh] overflow-y-auto">
                <div v-if="!isNewItem" class="relative aspect-[16/9]">
                    <img :src="selectedItem.itemImage" class="w-full h-full object-cover">
                </div>
                <div class="p-8 space-y-6 text-left">
                    <div class="flex justify-between items-start">
                        <h3 class="text-2xl font-serif-sc text-slate-900">{{ isNewItem ? '识别结果' : selectedItem.name }}</h3>
                        <button @click="closeResult"><span v-html="getIcon('x', 'w-6 h-6 text-slate-300')"></span></button>
                    </div>

                    <!-- 面料成分展示优化 -->
                    <div v-if="currentAnalysis" class="space-y-6">
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">面料成分</label>
                            <div class="flex flex-wrap gap-2">
                                <template v-for="(v, k) in parsedComposition" :key="k">
                                    <div class="flex items-center gap-2 px-3 py-2 bg-slate-50 border border-slate-100 rounded-xl">
                                        <span class="text-xs font-bold text-slate-700">{{ k }}</span>
                                        <span class="text-xs text-amber-600 bg-amber-50 px-1.5 py-0.5 rounded font-mono font-bold">{{ v }}</span>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="p-4 bg-slate-50 rounded-2xl">
                                <label class="text-[10px] font-bold text-slate-400 uppercase block mb-2 tracking-widest">洗涤建议</label>
                                <p class="text-sm text-slate-600 leading-relaxed">{{ currentAnalysis.laundry_guide }}</p>
                            </div>
                            <div class="p-4 bg-slate-50 rounded-2xl">
                                <label class="text-[10px] font-bold text-slate-400 uppercase block mb-2 tracking-widest">烘干/熨烫</label>
                                <p class="text-sm text-slate-600 leading-relaxed">{{ currentAnalysis.drying_guide || '自然晾干' }} / {{ currentAnalysis.iron_guide || '低温熨烫' }}</p>
                            </div>
                        </div>

                        <div class="p-5 bg-slate-900 rounded-2xl relative overflow-hidden">
                            <div class="absolute -right-4 -top-4 opacity-10 text-white">
                                <span v-html="getIcon('sparkles', 'w-24 h-24')"></span>
                            </div>
                            <label class="text-[10px] font-bold text-amber-400/60 uppercase block mb-2 tracking-widest">高端洞察</label>
                            <p class="text-sm text-amber-100 leading-relaxed italic relative z-10">{{ currentAnalysis.luxury_insight }}</p>
                        </div>
                    </div>
                    
                    <div v-if="isNewItem" class="flex gap-4 pt-4">
                        <button @click="closeResult" class="flex-1 py-4 bg-slate-50 rounded-2xl font-bold text-slate-400">放弃</button>
                        <button @click="saveToWardrobe" :disabled="isSaving" class="flex-1 py-4 bg-slate-900 text-white rounded-2xl font-bold shadow-xl active:scale-95 transition-all">
                            {{ isSaving ? '上传中...' : '同步至衣橱' }}
                        </button>
                    </div>
                    <div v-else class="pt-4 flex flex-col items-center gap-4">
                        <button @click="deleteItem" :disabled="isDeleting" class="text-red-400 text-xs font-medium flex items-center gap-1 hover:opacity-70 transition-opacity">
                            <span v-html="getIcon(isDeleting ? 'loader' : 'trash-2', 'w-3 h-3 ' + (isDeleting ? 'animate-spin' : ''))"></span> 
                            {{ isDeleting ? '正在从云端移除...' : '移除衣物' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 悬浮新增按钮 -->
        <footer v-if="currentView === 'home'" class="fixed bottom-0 left-0 right-0 p-8 flex justify-center z-20 pointer-events-none">
            <button @click="goAdd" class="bg-slate-900 text-white px-8 py-4 rounded-full flex items-center gap-3 shadow-2xl active:scale-95 transition-all pointer-events-auto">
                <span v-html="getIcon('plus', 'w-5 h-5')"></span>
                <span class="font-bold">新增衣物识别</span>
            </button>
        </footer>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick } = Vue;

        createApp({
            setup() {
                const wardrobe = ref([]);
                const currentView = ref('home');
                const loading = ref(false);
                const isSaving = ref(false);
                const isDeleting = ref(false);
                const showSettings = ref(false);
                
                // 配置状态
                const apiKey = ref(localStorage.getItem('gemini_api_key') || '');
                const cloudName = ref(localStorage.getItem('cl_cloud_name') || '');
                const uploadPreset = ref(localStorage.getItem('cl_upload_preset') || '');
                const clApiKey = ref(localStorage.getItem('cl_api_key') || '');
                const clApiSecret = ref(localStorage.getItem('cl_api_secret') || '');
                
                const tempApiKey = ref(apiKey.value);
                const tempCloudName = ref(cloudName.value);
                const tempUploadPreset = ref(uploadPreset.value);
                const tempClApiKey = ref(clApiKey.value);
                const tempClApiSecret = ref(clApiSecret.value);

                const currentLoadingMessage = ref('正在分析衣服...');
                const showResultModal = ref(false);
                const isNewItem = ref(false);
                
                const itemImageInput = ref(null);
                const labelImageInput = ref(null);
                const newItem = ref({ name: '', itemImage: null, labelImages: [] });
                const selectedItem = ref(null);
                const currentAnalysis = ref(null);

                const isCloudConfigured = computed(() => !!(cloudName.value && uploadPreset.value));

                // 高级成分解析逻辑：处理 AI 的各种返回格式
                const parsedComposition = computed(() => {
                    if (!currentAnalysis.value || !currentAnalysis.value.composition) return {};
                    const raw = currentAnalysis.value.composition;
                    if (typeof raw === 'object' && !Array.isArray(raw)) return raw;
                    if (Array.isArray(raw)) {
                        const obj = {};
                        raw.forEach(i => {
                            if (typeof i === 'string') {
                                const parts = i.split(/[:：\s]/);
                                if (parts.length >= 2) obj[parts[0]] = parts[1];
                            } else if (i.name && i.value) {
                                obj[i.name] = i.value;
                            }
                        });
                        return obj;
                    }
                    if (typeof raw === 'string') {
                        const obj = {};
                        raw.split(/[,，;；\n]/).forEach(s => {
                            const p = s.split(/[:：]/);
                            if (p.length >= 2) obj[p[0].trim()] = p[1].trim();
                        });
                        return obj;
                    }
                    return { "成分": "见摘要" };
                });

                onMounted(() => {
                    loadWardrobe();
                    nextTick(() => lucide.createIcons());
                });

                const loadWardrobe = () => {
                    const saved = localStorage.getItem('my_smart_wardrobe_data');
                    if (saved) {
                        try {
                            wardrobe.value = JSON.parse(saved).sort((a, b) => b.createdAt - a.createdAt);
                        } catch (e) { wardrobe.value = []; }
                    }
                };

                const saveSettings = () => {
                    localStorage.setItem('gemini_api_key', tempApiKey.value);
                    localStorage.setItem('cl_cloud_name', tempCloudName.value);
                    localStorage.setItem('cl_upload_preset', tempUploadPreset.value);
                    localStorage.setItem('cl_api_key', tempClApiKey.value);
                    localStorage.setItem('cl_api_secret', tempClApiSecret.value);
                    
                    apiKey.value = tempApiKey.value;
                    cloudName.value = tempCloudName.value;
                    uploadPreset.value = tempUploadPreset.value;
                    clApiKey.value = tempClApiKey.value;
                    clApiSecret.value = tempClApiSecret.value;
                    showSettings.value = false;
                };

                const getIcon = (name, className) => {
                    if (window.lucide && window.lucide.icons[name]) {
                        return window.lucide.icons[name].toSvg({ class: className || 'w-5 h-5' });
                    }
                    return '';
                };

                const goHome = () => { currentView.value = 'home'; resetNewItem(); nextTick(() => lucide.createIcons()); };
                const goAdd = () => { currentView.value = 'add'; nextTick(() => lucide.createIcons()); };
                const resetNewItem = () => { newItem.value = { name: '', itemImage: null, labelImages: [] }; isNewItem.value = false; };

                const triggerFile = (type) => {
                    const el = type === 'itemImage' ? itemImageInput.value : labelImageInput.value;
                    if (el) el.click();
                };

                const handleFile = async (event, type) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let w = img.width, h = img.height, max = 1024;
                            if (w > max) { h = (max/w)*h; w = max; }
                            canvas.width = w; canvas.height = h;
                            canvas.getContext('2d').drawImage(img,0,0,w,h);
                            const compressed = canvas.toDataURL('image/jpeg', 0.85);
                            if (type === 'itemImage') newItem.value.itemImage = compressed;
                            else newItem.value.labelImages.push(compressed);
                        };
                    };
                    reader.readAsDataURL(file);
                };

                const startAnalysis = async () => {
                    if (!apiKey.value) { showSettings.value = true; return; }
                    loading.value = true;
                    currentLoadingMessage.value = '正在通过 Gemini 识封面料信息...';
                    
                    const b64s = newItem.value.labelImages.map(img => img.split(',')[1]);
                    const payload = {
                        contents: [{ parts: [
                            { text: `分析衣服"${newItem.value.name}"。请以JSON格式输出。` },
                            ...b64s.map(b => ({ inlineData: { mimeType: "image/jpeg", data: b } }))
                        ]}],
                        systemInstruction: { parts: [{ text: "你是资深面料管家。请输出 JSON：{composition (对象格式，如{'羊毛':'100%'}), composition_summary, laundry_guide, drying_guide, iron_guide, luxury_insight}。" }] },
                        generationConfig: { responseMimeType: "application/json" }
                    };

                    try {
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey.value}`;
                        const res = await fetch(url, { method: 'POST', body: JSON.stringify(payload) });
                        const data = await res.json();
                        currentAnalysis.value = JSON.parse(data.candidates[0].content.parts[0].text);
                        isNewItem.value = true;
                        showResultModal.value = true;
                        nextTick(() => lucide.createIcons());
                    } catch (err) {
                        alert("AI 分析失败，请检查 Gemini API Key。");
                    } finally {
                        loading.value = false;
                    }
                };

                // 云端上传并记录 Public ID
                const uploadToCloudinary = async (base64) => {
                    if (!cloudName.value || !uploadPreset.value) return { url: base64, publicId: null };
                    const formData = new FormData();
                    formData.append('file', base64);
                    formData.append('upload_preset', uploadPreset.value);
                    try {
                        const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName.value}/image/upload`, {
                            method: 'POST',
                            body: formData
                        });
                        const data = await res.json();
                        return { url: data.secure_url, publicId: data.public_id };
                    } catch (e) {
                        return { url: base64, publicId: null };
                    }
                };

                // 云端物理删除图片
                const deleteFromCloudinary = async (publicId) => {
                    if (!publicId || !clApiKey.value || !clApiSecret.value || !cloudName.value) return false;
                    const timestamp = Math.round((new Date()).getTime() / 1000);
                    const stringToSign = `public_id=${publicId}&timestamp=${timestamp}${clApiSecret.value}`;
                    const signature = sha1(stringToSign);
                    const formData = new FormData();
                    formData.append('public_id', publicId);
                    formData.append('timestamp', timestamp);
                    formData.append('api_key', clApiKey.value);
                    formData.append('signature', signature);
                    try {
                        await fetch(`https://api.cloudinary.com/v1_1/${cloudName.value}/image/destroy`, { method: 'POST', body: formData });
                        return true;
                    } catch (e) { return false; }
                };

                const saveToWardrobe = async () => {
                    isSaving.value = true;
                    currentLoadingMessage.value = '正在同步至云端...';
                    try {
                        const uploadRes = await uploadToCloudinary(newItem.value.itemImage);
                        const itemToAdd = {
                            id: Date.now().toString(),
                            name: newItem.value.name,
                            itemImage: uploadRes.url,
                            publicId: uploadRes.publicId, // 关键：记录 ID 用于后续删除
                            analysis: currentAnalysis.value,
                            createdAt: Date.now()
                        };
                        wardrobe.value.unshift(itemToAdd);
                        localStorage.setItem('my_smart_wardrobe_data', JSON.stringify(wardrobe.value));
                        showResultModal.value = false;
                        goHome();
                    } catch (e) {
                        alert("保存失败");
                    } finally { isSaving.value = false; }
                };

                const showDetail = (item) => { 
                    selectedItem.value = item; 
                    currentAnalysis.value = item.analysis; 
                    isNewItem.value = false; 
                    showResultModal.value = true; 
                    nextTick(() => lucide.createIcons());
                };

                const deleteItem = async () => {
                    if (!confirm("确定移除并从云端彻底删除图片吗？")) return;
                    isDeleting.value = true;
                    const item = selectedItem.value;
                    if (item.publicId && clApiSecret.value) {
                        await deleteFromCloudinary(item.publicId);
                    }
                    wardrobe.value = wardrobe.value.filter(i => i.id !== item.id);
                    localStorage.setItem('my_smart_wardrobe_data', JSON.stringify(wardrobe.value));
                    isDeleting.value = false;
                    showResultModal.value = false;
                };

                const closeResult = () => { if(!isSaving.value && !isDeleting.value) { showResultModal.value = false; selectedItem.value = null; } };
                const isReadyToAnalyze = computed(() => newItem.value.name && newItem.value.itemImage && newItem.value.labelImages.length > 0);

                return {
                    wardrobe, currentView, newItem, loading, isSaving, isDeleting, showResultModal, currentAnalysis, isNewItem, isReadyToAnalyze, selectedItem,
                    showSettings, tempApiKey, apiKey, tempCloudName, tempUploadPreset, isCloudConfigured,
                    tempClApiKey, tempClApiSecret, clApiKey, clApiSecret,
                    itemImageInput, labelImageInput, currentLoadingMessage, parsedComposition,
                    getIcon, goHome, goAdd, handleFile, triggerFile, startAnalysis, saveToWardrobe, showDetail, closeResult, saveSettings, deleteItem
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
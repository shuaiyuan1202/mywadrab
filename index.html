<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#FDFCF9">
    <title>我的智能衣橱 - 飞书同步版</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha1/0.6.0/sha1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #FDFCF9; -webkit-tap-highlight-color: transparent; }
        .font-serif-sc { font-family: 'Noto Serif SC', serif; }
        .glass-effect { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .card-shadow { box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05); }
        [v-cloak] { display: none; }
        .loading-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .loader-ring { border: 2px solid #f3f3f3; border-top: 2px solid #0f172a; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .zoom-fade-enter-active, .zoom-fade-leave-active { transition: opacity 0.3s ease, transform 0.3s ease; }
        .zoom-fade-enter-from, .zoom-fade-leave-to { opacity: 0; transform: scale(0.95); }
    </style>
</head>
<body>
    <div id="app" v-cloak class="min-h-screen flex flex-col relative overflow-x-hidden">
        
        <!-- 全屏加载/锁定遮罩层 -->
        <div v-if="loading || isDeleting || isReplacing" class="fixed inset-0 z-[110] bg-white/95 backdrop-blur-md flex flex-col items-center justify-center p-10">
            <div class="loader-ring mb-6"></div>
            <div class="text-center space-y-3">
                <p class="text-slate-900 font-serif-sc text-lg loading-pulse">{{ currentLoadingMessage }}</p>
                <p class="text-slate-400 text-[10px] tracking-[0.2em] uppercase font-bold">{{ currentLoadingSubMessage }}</p>
            </div>
        </div>

        <!-- 页面顶部 -->
        <header class="sticky top-0 z-30 glass-effect border-b border-slate-100 px-6 py-4 flex justify-between items-center">
            <h1 class="text-xl font-serif-sc text-slate-900">我的衣橱</h1>
            <div class="flex items-center gap-3">
                <div @click="showSettings = true" class="flex items-center gap-1.5 px-2 py-1 rounded-full bg-slate-50 border border-slate-100 cursor-pointer hover:bg-slate-100 transition-colors">
                    <div class="w-2 h-2 rounded-full" :class="[isFeishuConfigured ? 'bg-indigo-500' : 'bg-gray-300']"></div>
                    <span class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">
                        {{ isFeishuConfigured ? 'Vercel Sync' : 'Local Only' }}
                    </span>
                </div>
                <button @click="showSettings = true" class="p-2 hover:bg-slate-100 rounded-full transition-colors text-slate-400">
                    <span v-html="getIcon('settings', 'w-5 h-5')"></span>
                </button>
            </div>
        </header>

        <!-- 设置弹窗 -->
        <div v-if="showSettings" class="fixed inset-0 z-50 flex items-center justify-center p-6">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="showSettings = false"></div>
            <div class="relative w-full max-w-sm bg-white rounded-[24px] p-6 shadow-2xl overflow-y-auto max-h-[85vh]">
                <h3 class="font-bold text-slate-900 mb-4 text-left">系统配置</h3>
                <div class="space-y-6">
                    <div class="space-y-1 text-left">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-1">Gemini API Key</label>
                        <input v-model="tempApiKey" type="password" placeholder="粘贴您的 API Key" class="w-full bg-slate-50 border border-slate-100 rounded-xl px-4 py-3 text-sm outline-none focus:border-slate-300 transition-colors">
                    </div>
                    
                    <div class="border-t border-slate-100 pt-4 text-left">
                        <h4 class="text-xs font-bold text-slate-900 mb-3">Cloudinary 图片存储</h4>
                        <div class="space-y-3">
                            <input v-model="tempCloudName" type="text" placeholder="Cloud Name" class="w-full bg-slate-50 border border-slate-100 rounded-xl px-4 py-3 text-sm outline-none">
                            <input v-model="tempUploadPreset" type="text" placeholder="Upload Preset" class="w-full bg-slate-50 border border-slate-100 rounded-xl px-4 py-3 text-sm outline-none">
                            <div class="p-3 bg-blue-50 rounded-xl mt-2">
                                <p class="text-[10px] text-blue-600 font-bold mb-2 uppercase tracking-tight">高级功能 (删除图片)</p>
                                <input v-model="tempClApiKey" type="text" placeholder="API Key" class="w-full bg-white border border-blue-100 rounded-lg px-3 py-2 text-[10px] mb-2 outline-none">
                                <input v-model="tempClApiSecret" type="password" placeholder="API Secret" class="w-full bg-white border border-blue-100 rounded-lg px-3 py-2 text-[10px] outline-none">
                            </div>
                        </div>
                    </div>

                    <!-- 飞书 / Vercel 配置区域 -->
                    <div class="border-t border-slate-100 pt-4 text-left">
                        <h4 class="text-xs font-bold text-slate-900 mb-3 flex items-center gap-2">
                            <span v-html="getIcon('server', 'w-3 h-3')"></span> 飞书多维表格同步 (Vercel 代理)
                        </h4>
                        <div class="space-y-3">
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Vercel Proxy URL</label>
                                <input v-model="tempVercelUrl" type="text" placeholder="https://your-app.vercel.app/api/feishu" class="w-full bg-indigo-50 border border-indigo-100 rounded-xl px-4 py-3 text-sm outline-none text-indigo-900 font-medium">
                            </div>
                            <input v-model="tempFsAppToken" type="text" placeholder="Base Token (URL中 app...)" class="w-full bg-slate-50 border border-slate-100 rounded-xl px-4 py-3 text-sm outline-none">
                            <input v-model="tempFsTableId" type="text" placeholder="Table ID (tbl...)" class="w-full bg-slate-50 border border-slate-100 rounded-xl px-4 py-3 text-sm outline-none">
                            
                            <div class="p-3 bg-green-50 rounded-xl text-[10px] text-green-700 leading-relaxed mt-2">
                                <div class="flex items-center gap-1 mb-1 font-bold">
                                    <span v-html="getIcon('shield-check', 'w-3 h-3')"></span> 安全同步模式
                                </div>
                                无需在前端填写 App ID 和 Secret。<br/>
                                请确保 Vercel 环境变量已配置 FEISHU_APP_ID 和 FEISHU_APP_SECRET。
                            </div>
                        </div>
                    </div>

                    <button @click="saveSettings" class="w-full py-4 bg-slate-900 text-white rounded-xl font-bold text-sm shadow-lg active:scale-95 transition-all">保存并应用</button>
                </div>
            </div>
        </div>

        <!-- 首页视图 -->
        <main v-if="currentView === 'home'" class="flex-1 p-6 pb-32 animate-in fade-in">
            <!-- 未配置提示 -->
            <div v-if="!isFeishuConfigured" class="mb-8 p-6 bg-slate-50 rounded-[24px] border border-slate-100 flex flex-col items-center text-center">
                <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center mb-4 text-slate-400 shadow-sm"><span v-html="getIcon('cloud-off', 'w-6 h-6')"></span></div>
                <h3 class="text-sm font-bold text-slate-900 mb-1 text-left">未连接云端数据库</h3>
                <p class="text-[11px] text-slate-500 mb-4 leading-relaxed">配置 Vercel 代理以安全同步数据至飞书。</p>
                <button @click="showSettings = true" class="px-6 py-2.5 bg-slate-900 text-white text-[11px] font-bold rounded-full shadow-md active:scale-95 transition-all">开始配置</button>
            </div>

            <!-- 视图切换器 -->
            <div class="flex justify-end mb-6">
                <div class="flex bg-slate-100 p-1 rounded-xl">
                    <button @click="changeViewMode('card')" :class="[viewMode === 'card' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-400']" class="p-2 rounded-lg transition-all"><span v-html="getIcon('layout-grid', 'w-4 h-4')"></span></button>
                    <button @click="changeViewMode('list')" :class="[viewMode === 'list' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-400']" class="p-2 rounded-lg transition-all"><span v-html="getIcon('list', 'w-4 h-4')"></span></button>
                </div>
            </div>

            <div v-if="wardrobe.length === 0" class="flex flex-col items-center justify-center py-24 text-slate-300">
                <div class="p-6 bg-white rounded-full shadow-inner mb-6"><span v-html="getIcon('shirt', 'w-12 h-12 opacity-20')"></span></div>
                <p class="text-slate-500 font-medium">您的衣橱是空的</p>
            </div>
            
            <div v-else :class="[viewMode === 'card' ? 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4' : 'flex flex-col gap-3']">
                <div v-for="item in wardrobe" :key="item.id" @click="showDetail(item)"
                     :class="[viewMode === 'card' ? 'flex-col' : 'flex-row items-center p-2 gap-4']"
                     class="group bg-white rounded-2xl overflow-hidden card-shadow border border-slate-50 cursor-pointer active:scale-95 transition-all flex">
                    <div :class="[viewMode === 'card' ? 'aspect-[3/4] w-full' : 'w-16 h-16 rounded-xl shrink-0']" class="bg-slate-100 relative overflow-hidden">
                        <img :src="viewMode === 'list' ? getThumbnail(item.itemImage) : item.itemImage" class="w-full h-full object-cover">
                    </div>
                    <div class="p-3 text-left flex-1">
                        <h3 class="font-medium text-slate-800 truncate text-sm">{{ item.name }}</h3>
                        <p class="text-[10px] text-slate-400 mt-1 uppercase truncate">{{ item.analysis?.composition_summary || '已存入' }}</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- 新增识别视图 -->
        <main v-if="currentView === 'add'" class="flex-1 p-6 animate-in slide-in-from-bottom-4">
            <div class="max-w-xl mx-auto space-y-6 text-left">
                <div @click="goHome" class="flex items-center gap-2 cursor-pointer text-slate-400 hover:text-slate-600 transition-colors">
                    <span v-html="getIcon('chevron-left', 'w-5 h-5')"></span>
                    <span class="text-sm font-medium">返回衣橱</span>
                </div>
                <h2 class="text-2xl font-serif-sc">识别并存储</h2>
                <div class="space-y-4">
                    <input v-model="newItem.name" type="text" placeholder="衣服名称（如：米色羊毛西装）" class="w-full bg-white border border-slate-200 rounded-2xl px-5 py-4 outline-none focus:border-slate-300 transition-colors shadow-sm">
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">全身展示照片</label>
                        <div @click="triggerFile('itemImage')" class="aspect-[16/10] bg-white border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center overflow-hidden cursor-pointer hover:border-slate-300 transition-colors bg-white">
                            <img v-if="newItem.itemImage" :src="newItem.itemImage" class="w-full h-full object-cover">
                            <span v-else v-html="getIcon('camera', 'w-8 h-8 text-slate-200')"></span>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">洗水标/面料细节</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div v-for="(img, idx) in newItem.labelImages" :key="idx" class="aspect-square rounded-2xl overflow-hidden relative shadow-sm">
                                <img :src="img" class="w-full h-full object-cover">
                                <button @click="newItem.labelImages.splice(idx,1)" class="absolute top-1 right-1 bg-black/50 text-white rounded-full p-1"><span v-html="getIcon('x', 'w-3 h-3')"></span></button>
                            </div>
                            <div v-if="newItem.labelImages.length < 2" @click="triggerFile('labelImage')" class="aspect-square border-2 border-dashed border-slate-200 rounded-2xl flex items-center justify-center cursor-pointer hover:border-slate-300 transition-colors bg-white">
                                <span v-html="getIcon('plus', 'w-5 h-5 text-slate-200')"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <input type="file" ref="itemImageInput" hidden accept="image/*" @change="handleFile($event, 'itemImage')">
                <input type="file" ref="labelImageInput" hidden accept="image/*" @change="handleFile($event, 'labelImage')">
                <button @click="startAnalysis" :disabled="!isReadyToAnalyze || loading" class="w-full py-5 rounded-2xl font-bold bg-slate-900 text-white disabled:bg-slate-200 transition-all shadow-lg shadow-slate-200 active:scale-95">启动智能分析</button>
            </div>
        </main>

        <!-- 识别结果/详情弹窗 -->
        <div v-if="showResultModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-0 sm:p-6">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="closeResult"></div>
            <div class="relative w-full max-w-2xl bg-white rounded-t-[32px] sm:rounded-[32px] shadow-2xl max-h-[90vh] overflow-y-auto">
                <div v-if="!isNewItem" class="relative aspect-[16/9] cursor-pointer group" @click="isDetailZoomed = true">
                    <img :src="selectedItem.itemImage" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent pointer-events-none"></div>
                    <div class="absolute bottom-6 left-8 text-white">
                         <p class="text-[10px] font-bold uppercase tracking-widest opacity-60 mb-1">Garment Archive</p>
                         <h3 class="text-2xl font-serif-sc">{{ selectedItem.name }}</h3>
                    </div>
                </div>
                <div class="p-8 space-y-6 text-left">
                    <div v-if="isNewItem" class="flex justify-between items-start">
                        <h3 class="text-2xl font-serif-sc text-slate-900">识别结果</h3>
                        <button @click="closeResult"><span v-html="getIcon('x', 'w-6 h-6 text-slate-300')"></span></button>
                    </div>

                    <div v-if="currentAnalysis" class="space-y-6">
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">面料成分</label>
                            <div class="flex flex-wrap gap-2">
                                <template v-for="(v, k) in parsedComposition" :key="k">
                                    <div class="flex items-center gap-2 px-3 py-2 bg-slate-50 border border-slate-100 rounded-xl">
                                        <span class="text-xs font-bold text-slate-700">{{ k }}</span>
                                        <span class="text-xs text-amber-600 bg-amber-50 px-1.5 py-0.5 rounded font-mono font-bold">{{ v }}</span>
                                    </div>
                                </template>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                <label class="text-[10px] font-bold text-slate-400 uppercase block mb-2">洗涤建议</label>
                                <p class="text-sm text-slate-600 leading-relaxed">{{ currentAnalysis.laundry_guide }}</p>
                            </div>
                            <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                <label class="text-[10px] font-bold text-slate-400 uppercase block mb-2">干燥/熨烫</label>
                                <p class="text-sm text-slate-600 leading-relaxed">{{ currentAnalysis.drying_guide || '自然晾干' }} / {{ currentAnalysis.iron_guide || '低温熨烫' }}</p>
                            </div>
                        </div>
                        <div class="p-6 bg-slate-900 rounded-2xl relative overflow-hidden shadow-xl">
                            <div class="absolute -right-4 -top-4 opacity-10 text-white transform rotate-12">
                                <span v-html="getIcon('sparkles', 'w-24 h-24')"></span>
                            </div>
                            <label class="text-[10px] font-bold text-amber-400/60 uppercase block mb-2 tracking-widest">面料洞察</label>
                            <p class="text-sm text-amber-100 leading-relaxed italic relative z-10 font-medium tracking-wide">{{ currentAnalysis.luxury_insight || currentAnalysis.fabric_insight }}</p>
                        </div>
                    </div>
                    
                    <div v-if="isNewItem" class="flex gap-4 pt-4">
                        <button @click="closeResult" class="flex-1 py-4 bg-slate-50 rounded-2xl font-bold text-slate-400 hover:bg-slate-100 transition-colors">暂不保存</button>
                        <button @click="saveToWardrobe" :disabled="isSaving" class="flex-1 py-4 bg-slate-900 text-white rounded-2xl font-bold shadow-xl active:scale-95 transition-all">
                            {{ isSaving ? '同步中...' : '确认入库' }}
                        </button>
                    </div>
                    <div v-else class="pt-4 flex flex-col items-center gap-4">
                        <button @click="deleteItem" :disabled="isDeleting" class="text-red-400 text-xs font-bold flex items-center gap-2 p-4 hover:opacity-70 transition-opacity">
                            <span v-html="getIcon('trash-2', 'w-4 h-4')"></span> 移除此衣物记录
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 全屏细节放大查看 & 封面替换 -->
        <transition name="zoom-fade">
            <!-- 点击背景区域（.self 修饰符）也可退出 -->
            <div v-if="isDetailZoomed && selectedItem" class="fixed inset-0 z-[120] bg-black flex flex-col" @click.self="isDetailZoomed = false">
                <div class="flex justify-between items-center p-6 bg-gradient-to-b from-black/60 to-transparent pointer-events-none">
                    <button @click="isDetailZoomed = false" class="text-white/60 hover:text-white transition-colors pointer-events-auto">
                        <span v-html="getIcon('chevron-left', 'w-6 h-6')"></span>
                    </button>
                    <div class="text-white/40 text-[10px] font-bold uppercase tracking-widest">Detail View</div>
                    <div class="w-6"></div>
                </div>
                
                <div class="flex-1 flex items-center justify-center p-4 pointer-events-none">
                    <img :src="selectedItem.itemImage" class="max-w-full max-h-full object-contain rounded-xl shadow-2xl">
                </div>

                <div class="p-8 pb-12 flex justify-center bg-gradient-to-t from-black/60 to-transparent">
                    <button @click="triggerReplaceCover" class="px-8 py-4 bg-white/10 backdrop-blur-md border border-white/20 text-white rounded-full font-bold text-sm flex items-center gap-3 active:scale-95 transition-all shadow-xl">
                        <span v-html="getIcon('image-plus', 'w-4 h-4')"></span>
                        替换当前封面图
                    </button>
                </div>
                <input type="file" ref="replaceCoverInput" hidden accept="image/*" @change="handleReplaceCover">
            </div>
        </transition>

        <!-- 悬浮新增按钮 -->
        <footer v-if="currentView === 'home'" class="fixed bottom-0 left-0 right-0 p-8 flex justify-center z-20 pointer-events-none">
            <button @click="goAdd" class="bg-slate-900 text-white px-8 py-4 rounded-full flex items-center gap-3 shadow-[0_20px_50px_rgba(0,0,0,0.3)] active:scale-95 transition-all pointer-events-auto border border-white/10">
                <span v-html="getIcon('plus-circle', 'w-5 h-5')"></span>
                <span class="font-bold tracking-wide">添加新衣物识别</span>
            </button>
        </footer>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

        createApp({
            setup() {
                const wardrobe = ref([]);
                const currentView = ref('home');
                const viewMode = ref(localStorage.getItem('wardrobe_view_mode') || 'card');
                const loading = ref(false);
                const isSaving = ref(false);
                const isDeleting = ref(false);
                const isReplacing = ref(false);
                const showSettings = ref(false);
                const isDetailZoomed = ref(false);
                
                // 配置状态
                const apiKey = ref(localStorage.getItem('gemini_api_key') || '');
                const cloudName = ref(localStorage.getItem('cl_cloud_name') || '');
                const uploadPreset = ref(localStorage.getItem('cl_upload_preset') || '');
                const clApiKey = ref(localStorage.getItem('cl_api_key') || '');
                const clApiSecret = ref(localStorage.getItem('cl_api_secret') || '');
                
                // 飞书配置
                const fsAppToken = ref(localStorage.getItem('fs_app_token') || '');
                const fsTableId = ref(localStorage.getItem('fs_table_id') || '');
                const vercelUrl = ref(localStorage.getItem('vercel_proxy_url') || '');

                const tempApiKey = ref(apiKey.value);
                const tempCloudName = ref(cloudName.value);
                const tempUploadPreset = ref(uploadPreset.value);
                const tempClApiKey = ref(clApiKey.value);
                const tempClApiSecret = ref(clApiSecret.value);
                
                const tempFsAppToken = ref(fsAppToken.value);
                const tempFsTableId = ref(fsTableId.value);
                const tempVercelUrl = ref(vercelUrl.value);

                // 智能分析文案切换系统
                const analyzeMessages = [
                    { title: "正在识别水洗标中的面料成分...", sub: "Fiber Recognition" },
                    { title: "正在基于面料成分评估洗护注意事项...", sub: "Care Assessment" },
                    { title: "正在通过织物特性构建面料管理洞察...", sub: "Insight Generation" },
                    { title: "正在为您同步数字衣橱档案...", subtitle: "Archive Syncing" }
                ];
                const currentLoadingMessage = ref(analyzeMessages[0].title);
                const currentLoadingSubMessage = ref(analyzeMessages[0].sub);
                let messageTimer = null;

                const showResultModal = ref(false);
                const isNewItem = ref(false);
                const newItem = ref({ name: '', itemImage: null, labelImages: [] });
                const selectedItem = ref(null);
                const currentAnalysis = ref(null);
                
                const itemImageInput = ref(null);
                const labelImageInput = ref(null);
                const replaceCoverInput = ref(null);

                const isFeishuConfigured = computed(() => !!(fsAppToken.value && fsTableId.value && vercelUrl.value));
                const isCloudConfigured = computed(() => !!(cloudName.value && uploadPreset.value));

                const startLoadingRotation = () => {
                    let idx = 0;
                    messageTimer = setInterval(() => {
                        idx = (idx + 1) % analyzeMessages.length;
                        currentLoadingMessage.value = analyzeMessages[idx].title;
                        currentLoadingSubMessage.value = analyzeMessages[idx].sub;
                    }, 2200);
                };

                const stopLoadingRotation = () => {
                    clearInterval(messageTimer);
                };

                const parsedComposition = computed(() => {
                    if (!currentAnalysis.value || !currentAnalysis.value.composition) return {};
                    const raw = currentAnalysis.value.composition;
                    if (typeof raw === 'object' && !Array.isArray(raw)) return raw;
                    const res = {};
                    if (Array.isArray(raw)) {
                        raw.forEach(i => {
                            if (typeof i === 'string') {
                                const p = i.split(/[:：\s]/);
                                if (p.length >= 2) res[p[0]] = p[1];
                            } else if (i.name && i.value) res[i.name] = i.value;
                        });
                        return res;
                    }
                    if (typeof raw === 'string') {
                        raw.split(/[,，;；\n]/).forEach(s => {
                            const p = s.split(/[:：]/);
                            if (p.length >= 2) res[p[0].trim()] = p[1].trim();
                        });
                        return res;
                    }
                    return { "成分": "见详情" };
                });

                onMounted(() => {
                    loadWardrobe(); // 优先从本地加载，再尝试云端同步
                    if (isFeishuConfigured.value) {
                        syncFromFeishu();
                    }
                    nextTick(() => lucide.createIcons());
                });

                const loadWardrobe = () => {
                    const saved = localStorage.getItem('my_smart_wardrobe_data');
                    if (saved) {
                        try {
                            wardrobe.value = JSON.parse(saved).sort((a, b) => b.createdAt - a.createdAt);
                        } catch (e) { wardrobe.value = []; }
                    }
                };

                const saveSettings = () => {
                    localStorage.setItem('gemini_api_key', tempApiKey.value);
                    localStorage.setItem('cl_cloud_name', tempCloudName.value);
                    localStorage.setItem('cl_upload_preset', tempUploadPreset.value);
                    localStorage.setItem('cl_api_key', tempClApiKey.value);
                    localStorage.setItem('cl_api_secret', tempClApiSecret.value);
                    
                    localStorage.setItem('fs_app_token', tempFsAppToken.value);
                    localStorage.setItem('fs_table_id', tempFsTableId.value);
                    localStorage.setItem('vercel_proxy_url', tempVercelUrl.value);

                    apiKey.value = tempApiKey.value;
                    cloudName.value = tempCloudName.value;
                    uploadPreset.value = tempUploadPreset.value;
                    clApiKey.value = tempClApiKey.value;
                    clApiSecret.value = tempClApiSecret.value;
                    
                    fsAppToken.value = tempFsAppToken.value;
                    fsTableId.value = tempFsTableId.value;
                    vercelUrl.value = tempVercelUrl.value;

                    showSettings.value = false;
                    
                    if (isFeishuConfigured.value) {
                        alert("配置已保存，正在尝试从飞书同步数据...");
                        syncFromFeishu();
                    }
                };

                // 通用 Vercel 代理调用函数
                const callVercelProxy = async (action, payload = {}) => {
                    if (!vercelUrl.value) throw new Error("Missing Vercel Proxy URL");
                    
                    // 构造完整的请求体
                    const body = {
                        app_token: fsAppToken.value,
                        table_id: fsTableId.value,
                        ...payload
                    };

                    // 使用 POST 请求发送所有操作（Vercel Function 常规做法）
                    // 并在 Query Params 中带上 action 以便路由
                    // 注意：URL 必须是正确的 Vercel Function 地址
                    const targetUrl = new URL(vercelUrl.value);
                    targetUrl.searchParams.set('action', action);

                    const res = await fetch(targetUrl.toString(), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });

                    if (!res.ok) throw new Error(`Proxy Error: ${res.statusText}`);
                    const data = await res.json();
                    if (data.code !== 0) throw new Error(data.msg || 'Feishu API Error');
                    return data;
                };

                const syncFromFeishu = async () => {
                    if (!isFeishuConfigured.value) return;
                    loading.value = true;
                    currentLoadingMessage.value = "正在从飞书同步数据...";
                    currentLoadingSubMessage.value = "SYNCING FEISHU";
                    
                    try {
                        // 调用 Vercel 代理获取列表
                        // 注意：这里使用 'list_records' 动作
                        const data = await callVercelProxy('list_records');
                        
                        if (data.data && data.data.items) {
                            const feishuItems = data.data.items.map(record => ({
                                record_id: record.record_id, 
                                id: record.fields.uuid || record.record_id,
                                name: record.fields.name,
                                itemImage: record.fields.image_url, 
                                publicId: record.fields.public_id,
                                analysis: record.fields.analysis ? JSON.parse(record.fields.analysis) : null,
                                createdAt: record.fields.created_at || Date.now()
                            }));
                            wardrobe.value = feishuItems.sort((a, b) => b.createdAt - a.createdAt);
                            localStorage.setItem('my_smart_wardrobe_data', JSON.stringify(wardrobe.value));
                        }
                    } catch (e) {
                        console.error("同步失败: ", e);
                        // 不阻断用户使用，仅记录日志
                    } finally {
                        loading.value = false;
                    }
                };

                const addToFeishu = async (item) => {
                    if (!isFeishuConfigured.value) return;
                    try {
                        await callVercelProxy('add_record', {
                            fields: {
                                name: item.name,
                                image_url: item.itemImage,
                                public_id: item.publicId,
                                analysis: JSON.stringify(item.analysis),
                                created_at: item.createdAt,
                                uuid: item.id
                            }
                        });
                        // 重新同步以获取 record_id
                        syncFromFeishu();
                    } catch (e) { console.error("Add to Feishu failed", e); }
                };

                const deleteFromFeishu = async (record_id) => {
                    if (!isFeishuConfigured.value || !record_id) return;
                    try {
                        await callVercelProxy('delete_record', { record_id });
                    } catch (e) { console.error("Delete from Feishu failed", e); }
                };

                const updateFeishuRecord = async (record_id, fields) => {
                    if (!isFeishuConfigured.value || !record_id) return;
                    try {
                        await callVercelProxy('update_record', { record_id, fields });
                    } catch (e) { console.error("Update Feishu failed", e); }
                };

                const getIcon = (name, className) => {
                    if (window.lucide && window.lucide.icons[name]) {
                        return window.lucide.icons[name].toSvg({ class: className || 'w-5 h-5' });
                    }
                    return '';
                };

                const getThumbnail = (url) => {
                    if (!url || !url.includes('cloudinary.com')) return url;
                    return url.replace('/upload/', '/upload/w_200,h_200,c_fill,q_auto/');
                };

                const changeViewMode = (mode) => {
                    viewMode.value = mode;
                    localStorage.setItem('wardrobe_view_mode', mode);
                    nextTick(() => lucide.createIcons());
                };

                const goHome = () => { currentView.value = 'home'; resetNewItem(); nextTick(() => lucide.createIcons()); };
                const goAdd = () => { currentView.value = 'add'; nextTick(() => lucide.createIcons()); };
                const resetNewItem = () => { newItem.value = { name: '', itemImage: null, labelImages: [] }; isNewItem.value = false; };

                const triggerFile = (type) => {
                    const el = type === 'itemImage' ? itemImageInput.value : labelImageInput.value;
                    if (el) el.click();
                };

                const handleFile = async (event, type) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let w = img.width, h = img.height, max = 1200;
                            if (w > max) { h = (max/w)*h; w = max; }
                            canvas.width = w; canvas.height = h;
                            canvas.getContext('2d').drawImage(img,0,0,w,h);
                            const compressed = canvas.toDataURL('image/jpeg', 0.88);
                            if (type === 'itemImage') newItem.value.itemImage = compressed;
                            else newItem.value.labelImages.push(compressed);
                        };
                    };
                    reader.readAsDataURL(file);
                };

                const startAnalysis = async () => {
                    if (!apiKey.value) { showSettings.value = true; return; }
                    loading.value = true;
                    currentLoadingSubMessage.value = "Gemini Processing";
                    startLoadingRotation();
                    
                    const b64s = newItem.value.labelImages.map(img => img.split(',')[1]);
                    const payload = {
                        contents: [{ parts: [
                            { text: `分析衣服"${newItem.value.name}"。JSON输出。` },
                            ...b64s.map(b => ({ inlineData: { mimeType: "image/jpeg", data: b } }))
                        ]}],
                        systemInstruction: { parts: [{ text: "资深奢侈品面料专家。JSON：{composition(对象), composition_summary, laundry_guide, drying_guide, iron_guide, fabric_insight}。" }] },
                        generationConfig: { responseMimeType: "application/json" }
                    };

                    try {
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey.value}`;
                        const res = await fetch(url, { method: 'POST', body: JSON.stringify(payload) });
                        const data = await res.json();
                        currentAnalysis.value = JSON.parse(data.candidates[0].content.parts[0].text);
                        isNewItem.value = true;
                        showResultModal.value = true;
                        nextTick(() => lucide.createIcons());
                    } catch (err) { alert("分析失败，请检查配置。"); } finally { loading.value = false; stopLoadingRotation(); }
                };

                const uploadToCloudinary = async (base64) => {
                    if (!cloudName.value || !uploadPreset.value) return { url: base64, publicId: null };
                    const formData = new FormData();
                    formData.append('file', base64);
                    formData.append('upload_preset', uploadPreset.value);
                    try {
                        const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName.value}/image/upload`, { method: 'POST', body: formData });
                        const data = await res.json();
                        return { url: data.secure_url, publicId: data.public_id };
                    } catch (e) { return { url: base64, publicId: null }; }
                };

                const deleteFromCloudinary = async (publicId) => {
                    if (!publicId || !clApiKey.value || !clApiSecret.value || !cloudName.value) return false;
                    const timestamp = Math.round((new Date()).getTime() / 1000);
                    const stringToSign = `public_id=${publicId}&timestamp=${timestamp}${clApiSecret.value}`;
                    const signature = sha1(stringToSign);
                    const formData = new FormData();
                    formData.append('public_id', publicId);
                    formData.append('timestamp', timestamp);
                    formData.append('api_key', clApiKey.value);
                    formData.append('signature', signature);
                    try {
                        await fetch(`https://api.cloudinary.com/v1_1/${cloudName.value}/image/destroy`, { method: 'POST', body: formData });
                        return true;
                    } catch (e) { return false; }
                };

                const saveToWardrobe = async () => {
                    isSaving.value = true;
                    loading.value = true;
                    currentLoadingMessage.value = "正在同步云端档案...";
                    currentLoadingSubMessage.value = "Cloud Syncing";
                    try {
                        const uploadRes = await uploadToCloudinary(newItem.value.itemImage);
                        const itemToAdd = {
                            id: 'CLO-' + Date.now().toString().slice(-6),
                            name: newItem.value.name,
                            itemImage: uploadRes.url,
                            publicId: uploadRes.publicId,
                            analysis: currentAnalysis.value,
                            createdAt: Date.now()
                        };
                        
                        // 先保存到本地
                        wardrobe.value.unshift(itemToAdd);
                        localStorage.setItem('my_smart_wardrobe_data', JSON.stringify(wardrobe.value));
                        
                        // 尝试同步到飞书 (通过 Proxy)
                        await addToFeishu(itemToAdd);

                        showResultModal.value = false;
                        goHome();
                    } catch (e) { alert("同步失败"); } finally { isSaving.value = false; loading.value = false; }
                };

                const triggerReplaceCover = () => replaceCoverInput.value.click();

                const handleReplaceCover = async (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    isReplacing.value = true;
                    currentLoadingMessage.value = "正在上传新图片并更新封面...";
                    currentLoadingSubMessage.value = "Replacing Cover";
                    
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const uploadRes = await uploadToCloudinary(e.target.result);
                        if (uploadRes.url) {
                            const oldPublicId = selectedItem.value.publicId;
                            // 更新列表和当前显示
                            selectedItem.value.itemImage = uploadRes.url;
                            selectedItem.value.publicId = uploadRes.publicId;
                            localStorage.setItem('my_smart_wardrobe_data', JSON.stringify(wardrobe.value));
                            
                            // 更新飞书 (通过 Proxy)
                            if (selectedItem.value.record_id) {
                                await updateFeishuRecord(selectedItem.value.record_id, {
                                    image_url: uploadRes.url,
                                    public_id: uploadRes.publicId
                                });
                            }

                            // 清理旧图
                            if (oldPublicId) await deleteFromCloudinary(oldPublicId);
                        }
                        isReplacing.value = false;
                        isDetailZoomed.value = false;
                    };
                    reader.readAsDataURL(file);
                };

                const showDetail = (item) => { 
                    selectedItem.value = item; 
                    currentAnalysis.value = item.analysis; 
                    isNewItem.value = false; 
                    showResultModal.value = true; 
                    nextTick(() => lucide.createIcons());
                };

                const deleteItem = async () => {
                    if (!confirm("确定移除此记录并销毁云端图片吗？")) return;
                    isDeleting.value = true;
                    currentLoadingMessage.value = "正在销毁云端数据...";
                    currentLoadingSubMessage.value = "Cloud Purging";
                    const item = selectedItem.value;
                    if (item.publicId && clApiSecret.value) {
                        await deleteFromCloudinary(item.publicId);
                    }
                    
                    // 飞书删除 (通过 Proxy)
                    if (item.record_id) {
                        await deleteFromFeishu(item.record_id);
                    }

                    wardrobe.value = wardrobe.value.filter(i => i.id !== item.id);
                    localStorage.setItem('my_smart_wardrobe_data', JSON.stringify(wardrobe.value));
                    isDeleting.value = false;
                    showResultModal.value = false;
                };

                const closeResult = () => { if(!isSaving.value && !isDeleting.value && !isReplacing.value) { showResultModal.value = false; selectedItem.value = null; } };
                const isReadyToAnalyze = computed(() => newItem.value.name && newItem.value.itemImage && newItem.value.labelImages.length > 0);

                return {
                    wardrobe, currentView, viewMode, newItem, loading, isSaving, isDeleting, isReplacing, showResultModal, currentAnalysis, isNewItem, isReadyToAnalyze, selectedItem, isDetailZoomed,
                    showSettings, tempApiKey, apiKey, tempCloudName, tempUploadPreset, isFeishuConfigured, isCloudConfigured,
                    tempClApiKey, tempClApiSecret, clApiKey, clApiSecret,
                    tempFsAppToken, tempFsTableId, tempVercelUrl,
                    itemImageInput, labelImageInput, replaceCoverInput, currentLoadingMessage, currentLoadingSubMessage, parsedComposition,
                    getIcon, goHome, goAdd, handleFile, triggerFile, startAnalysis, saveToWardrobe, showDetail, closeResult, saveSettings, deleteItem,
                    triggerReplaceCover, handleReplaceCover, getThumbnail, changeViewMode
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
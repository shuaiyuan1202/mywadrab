<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWA 配置 -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FDFCF9">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3534/3534312.png">
    
    <title>我的智能衣橱 - 长期主义洗护专家</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #FDFCF9; }
        .font-serif-sc { font-family: 'Noto Serif SC', serif; }
        .glass-effect { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .card-shadow { box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        [v-cloak] { display: none; }
        .img-edit-overlay { background: linear-gradient(to top, rgba(0,0,0,0.6), transparent); }
    </style>
</head>
<body>
    <div id="app" v-cloak class="min-h-screen flex flex-col">
        <!-- 页面顶部 -->
        <header class="sticky top-0 z-30 glass-effect border-b border-slate-100 px-6 py-4 flex justify-between items-center">
            <h1 class="text-xl font-serif-sc text-slate-900">我的衣橱</h1>
            <div class="flex items-center gap-3">
                <div v-if="currentView === 'home'" class="text-xs text-slate-400 font-medium bg-slate-100 px-2 py-1 rounded-md">
                    {{ wardrobe.length }} 件
                </div>
                <!-- 设置按钮 -->
                <button @click="showSettings = true" class="p-2 hover:bg-slate-100 rounded-full transition-colors text-slate-400">
                    <span v-html="getIcon('settings', 'w-5 h-5')"></span>
                </button>
            </div>
        </header>

        <!-- 设置弹窗 -->
        <div v-if="showSettings" class="fixed inset-0 z-50 flex items-center justify-center p-6 animate-in fade-in duration-200">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="showSettings = false"></div>
            <div class="relative w-full max-w-sm bg-white rounded-[24px] p-6 shadow-2xl text-left">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-slate-900">API 设置</h3>
                    <button @click="showSettings = false" class="text-slate-300"><span v-html="getIcon('x', 'w-5 h-5')"></span></button>
                </div>
                <div class="space-y-4 text-left">
                    <p class="text-xs text-slate-400 leading-relaxed text-left">请输入您的 Gemini API Key。Key 将仅保存在您的浏览器本地，不会上传到服务器。</p>
                    <input v-model="tempApiKey" type="password" placeholder="粘贴您的 API Key" 
                           class="w-full bg-slate-50 border border-slate-100 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-amber-200 outline-none text-left">
                    <button @click="saveSettings" class="w-full py-3 bg-slate-900 text-white rounded-xl font-bold text-sm">保存配置</button>
                </div>
            </div>
        </div>

        <!-- 首页：衣橱展示 -->
        <main v-if="currentView === 'home'" class="flex-1 p-6 pb-32 animate-in fade-in duration-300">
            <div v-if="wardrobe.length === 0" class="flex flex-col items-center justify-center py-24 text-slate-300">
                <div class="p-6 bg-white rounded-full shadow-inner mb-6">
                    <span v-html="getIcon('shirt', 'w-12 h-12 opacity-20')"></span>
                </div>
                <p>衣橱空空如也</p>
                <button @click="goAdd" class="text-amber-600 text-sm mt-4 font-bold underline">点此新增衣物</button>
            </div>
            
            <div v-else class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 text-left">
                <div v-for="item in wardrobe" :key="item.id" @click="showDetail(item)"
                     class="group bg-white rounded-2xl overflow-hidden card-shadow border border-slate-50 cursor-pointer active:scale-95 transition-all">
                    <div class="aspect-[3/4] overflow-hidden bg-slate-100 relative">
                        <img :src="item.itemImage" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    </div>
                    <div class="p-3">
                        <h3 class="font-medium text-slate-800 truncate text-left">{{ item.name }}</h3>
                        <p class="text-[10px] text-slate-400 mt-1 uppercase text-left">{{ item.analysis.composition_summary }}</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- 新增视图 -->
        <main v-if="currentView === 'add'" class="flex-1 p-6 animate-in slide-in-from-bottom-4">
            <div class="max-w-xl mx-auto space-y-6 text-left">
                <div class="flex items-center gap-2 mb-4 cursor-pointer" @click="goHome">
                    <span v-html="getIcon('chevron-left', 'w-5 h-5 text-slate-400')"></span>
                    <span class="text-slate-400 text-sm">返回</span>
                </div>
                <h2 class="text-2xl font-serif-sc text-slate-900 text-left">新增衣物识别</h2>
                
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest text-left block">衣物名称</label>
                    <input v-model="newItem.name" type="text" placeholder="输入衣服名称" class="w-full bg-white border border-slate-200 rounded-2xl px-5 py-4 outline-none text-left">
                </div>
                
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest text-left block">实物照片</label>
                    <div @click="triggerFile('itemImage')" class="aspect-video bg-white border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center overflow-hidden cursor-pointer">
                        <img v-if="newItem.itemImage" :src="newItem.itemImage" class="w-full h-full object-cover">
                        <div v-else class="text-center">
                            <span v-html="getIcon('camera', 'w-8 h-8 text-slate-200 mx-auto')"></span>
                            <p class="text-xs text-slate-300 mt-2">点击拍摄实物美照</p>
                        </div>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest text-left block">水洗标图片 (最多2张)</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div v-for="(img, idx) in newItem.labelImages" :key="idx" class="aspect-square rounded-2xl overflow-hidden relative">
                            <img :src="img" class="w-full h-full object-cover">
                            <button @click="newItem.labelImages.splice(idx,1)" class="absolute top-1 right-1 bg-black/50 text-white rounded-full p-1"><span v-html="getIcon('x', 'w-3 h-3')"></span></button>
                        </div>
                        <div v-if="newItem.labelImages.length < 2" @click="triggerFile('labelImage')" class="aspect-square border-2 border-dashed border-slate-200 rounded-2xl flex items-center justify-center cursor-pointer">
                            <span v-html="getIcon('plus', 'w-5 h-5 text-slate-200')"></span>
                        </div>
                    </div>
                </div>

                <input type="file" ref="itemImageInput" hidden accept="image/*" @change="handleFile($event, 'itemImage')">
                <input type="file" ref="labelImageInput" hidden accept="image/*" @change="handleFile($event, 'labelImage')">

                <button @click="startAnalysis" :disabled="!isReadyToAnalyze || loading" class="w-full py-5 rounded-2xl font-bold bg-slate-900 text-white disabled:bg-slate-200 shadow-xl transition-all">
                    {{ loading ? '专家识别中...' : '开始AI分析方案' }}
                </button>
            </div>
        </main>

        <!-- 详情/分析结果弹窗 -->
        <div v-if="showResultModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-0 sm:p-6 animate-in fade-in">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="closeResult"></div>
            <div class="relative w-full max-w-2xl bg-white rounded-t-[32px] sm:rounded-[32px] shadow-2xl max-h-[90vh] overflow-y-auto safe-area-bottom text-left">
                <!-- 详情模式下的封面维护 -->
                <div v-if="!isNewItem" class="relative aspect-video">
                    <img :src="selectedItem.itemImage" class="w-full h-full object-cover">
                    <div class="absolute inset-0 flex items-end justify-center p-4 img-edit-overlay">
                        <button @click="triggerFile('editImage')" class="bg-white/20 backdrop-blur-md text-white px-4 py-2 rounded-full text-xs font-medium border border-white/10">更换封面照片</button>
                    </div>
                    <input type="file" ref="editImageInput" hidden accept="image/*" @change="handleFile($event, 'editImage')">
                </div>

                <div class="p-8">
                    <div class="flex justify-between items-start mb-8">
                        <div>
                            <h3 class="text-2xl font-serif-sc text-slate-900 text-left">{{ isNewItem ? '洗护方案' : selectedItem.name }}</h3>
                            <p v-if="!isNewItem" class="text-[10px] text-slate-400 mt-1 uppercase tracking-widest text-left">存档时间: {{ new Date(selectedItem.id).toLocaleDateString() }}</p>
                        </div>
                        <button @click="closeResult" class="p-2 hover:bg-slate-50 rounded-full"><span v-html="getIcon('x', 'w-6 h-6 text-slate-300')"></span></button>
                    </div>

                    <div class="space-y-8 text-left">
                        <!-- 成分比例 -->
                        <div>
                            <div class="flex items-center gap-2 mb-4">
                                <span v-html="getIcon('shield-check', 'w-4 h-4 text-amber-500')"></span>
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest text-left">成分比例</span>
                            </div>
                            <div class="flex flex-wrap gap-2 text-left">
                                <div v-for="(val, key) in currentAnalysis.composition" :key="key" class="px-4 py-2 bg-slate-50 rounded-xl text-sm border border-slate-100 text-left">
                                    <span class="text-slate-500">{{ key }}</span> <span class="font-bold text-amber-600 ml-1">{{ val }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- 洗护建议 -->
                        <div class="grid grid-cols-1 gap-6 text-left">
                            <div class="flex gap-4 text-left">
                                <div class="w-10 h-10 shrink-0 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600 font-bold">洗</div>
                                <div>
                                    <h4 class="text-sm font-bold text-slate-700 mb-1 text-left">洗涤指南</h4>
                                    <p class="text-sm text-slate-500 leading-relaxed text-left">{{ currentAnalysis.laundry_guide }}</p>
                                </div>
                            </div>
                            <div class="flex gap-4 text-left">
                                <div class="w-10 h-10 shrink-0 bg-orange-50 rounded-xl flex items-center justify-center text-orange-600 font-bold">晒</div>
                                <div>
                                    <h4 class="text-sm font-bold text-slate-700 mb-1 text-left">晾晒建议</h4>
                                    <p class="text-sm text-slate-500 leading-relaxed text-left">{{ currentAnalysis.drying_guide }}</p>
                                </div>
                            </div>
                            <div class="flex gap-4 text-left">
                                <div class="w-10 h-10 shrink-0 bg-slate-50 rounded-xl flex items-center justify-center text-slate-600 font-bold">烫</div>
                                <div>
                                    <h4 class="text-sm font-bold text-slate-700 mb-1 text-left">熨烫说明</h4>
                                    <p class="text-sm text-slate-500 leading-relaxed text-left">{{ currentAnalysis.iron_guide }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- 长期观察 -->
                        <div class="bg-slate-900 text-slate-100 p-8 rounded-[24px] relative overflow-hidden shadow-2xl text-left">
                            <span v-html="getIcon('sparkles', 'absolute -top-4 -right-4 w-24 h-24 opacity-5 rotate-12')"></span>
                            <h4 class="text-[10px] font-bold text-amber-400 uppercase tracking-widest mb-4 text-left">长期主义观察</h4>
                            <p class="text-sm font-serif italic mb-6 leading-relaxed opacity-90 text-left">{{ currentAnalysis.luxury_insight }}</p>
                            <div class="pt-6 border-t border-slate-800 text-left">
                                <h5 class="text-[10px] text-slate-500 uppercase tracking-widest mb-2 text-left">如何长效维持质感</h5>
                                <p class="text-xs leading-relaxed opacity-70 text-left">{{ currentAnalysis.long_term_tips }}</p>
                            </div>
                        </div>
                    </div>

                    <div v-if="isNewItem" class="flex gap-4 mt-10">
                        <button @click="closeResult" class="flex-1 py-4 bg-slate-50 text-slate-500 font-bold rounded-2xl hover:bg-slate-100 transition-colors">丢弃识别结果</button>
                        <button @click="saveToWardrobe" class="flex-1 py-4 bg-amber-600 text-white font-bold rounded-2xl hover:bg-amber-700 shadow-lg shadow-amber-900/20">存入我的衣橱</button>
                    </div>
                    <div v-else class="mt-8 text-center">
                        <button @click="deleteItem" class="text-red-400 text-xs font-medium flex items-center gap-1 mx-auto opacity-50 hover:opacity-100 transition-opacity">
                            <span v-html="getIcon('trash-2', 'w-3 h-3')"></span>
                            移出我的衣橱
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <footer v-if="currentView === 'home'" class="fixed bottom-0 left-0 right-0 p-8 flex justify-center z-20">
            <button @click="goAdd" class="bg-slate-900 text-white px-8 py-4 rounded-full flex items-center gap-3 shadow-2xl hover:-translate-y-1 transition-all active:scale-95">
                <span v-html="getIcon('plus', 'w-5 h-5')"></span>
                <span class="font-bold">新增衣物识别</span>
            </button>
        </footer>
    </div>

    <script>
        // 安全注册 Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // 仅在 http 或 https 协议下尝试注册，防止 blob 环境报错
                if (window.location.protocol.startsWith('http')) {
                    navigator.serviceWorker.register('./sw.js')
                        .then(reg => console.log('SW Registered'))
                        .catch(err => console.log('SW Registration suppressed due to environment/protocol.'));
                }
            });
        }

        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const wardrobe = ref([]);
                const currentView = ref('home');
                const loading = ref(false);
                const showResultModal = ref(false);
                const isNewItem = ref(false);
                const showSettings = ref(false);
                
                // API Key 管理
                const apiKey = ref(localStorage.getItem('gemini_api_key') || '');
                const tempApiKey = ref(apiKey.value);

                const itemImageInput = ref(null);
                const labelImageInput = ref(null);
                const editImageInput = ref(null);
                const newItem = ref({ name: '', itemImage: null, labelImages: [] });
                const selectedItem = ref(null);
                const currentAnalysis = ref(null);

                onMounted(() => {
                    const saved = localStorage.getItem('smart_wardrobe_v2');
                    if (saved) wardrobe.value = JSON.parse(saved);
                });

                const saveSettings = () => {
                    apiKey.value = tempApiKey.value;
                    localStorage.setItem('gemini_api_key', tempApiKey.value);
                    showSettings.value = false;
                };

                const getIcon = (name, className) => {
                    if (window.lucide && window.lucide.icons && window.lucide.icons[name]) {
                        return window.lucide.icons[name].toSvg({ class: className || 'w-5 h-5' });
                    }
                    return '';
                };

                const goHome = () => { currentView.value = 'home'; resetNewItem(); };
                const goAdd = () => { currentView.value = 'add'; };
                const resetNewItem = () => { newItem.value = { name: '', itemImage: null, labelImages: [] }; isNewItem.value = false; };

                const triggerFile = (type) => {
                    if (type === 'itemImage') itemImageInput.value.click();
                    else if (type === 'labelImage') labelImageInput.value.click();
                    else if (type === 'editImage') editImageInput.value.click();
                };

                const handleFile = (event, type) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        if (type === 'itemImage') newItem.value.itemImage = e.target.result;
                        else if (type === 'labelImage') newItem.value.labelImages.push(e.target.result);
                        else if (type === 'editImage' && selectedItem.value) {
                            selectedItem.value.itemImage = e.target.result;
                            localStorage.setItem('smart_wardrobe_v2', JSON.stringify(wardrobe.value));
                        }
                    };
                    reader.readAsDataURL(file);
                    event.target.value = '';
                };

                const startAnalysis = async () => {
                    if (!apiKey.value) {
                        showSettings.value = true;
                        return;
                    }
                    loading.value = true;
                    const b64s = newItem.value.labelImages.map(img => img.split(',')[1]);
                    const payload = {
                        contents: [{
                            parts: [
                                { text: `分析这件名为"${newItem.value.name}"的衣物。输出JSON格式。` },
                                ...b64s.map(b => ({ inlineData: { mimeType: "image/png", data: b } }))
                            ]
                        }],
                        systemInstruction: { parts: [{ text: "你是一位面料专家。分析并返回 JSON：{composition: {'成分': '比例'}, composition_summary, laundry_guide, drying_guide, iron_guide, luxury_insight, long_term_tips}。严禁嵌套，确保字段完整。中文回复。" }] },
                        generationConfig: { responseMimeType: "application/json" }
                    };

                    try {
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey.value}`;
                        const res = await fetch(url, { method: 'POST', body: JSON.stringify(payload) });
                        const data = await res.json();
                        currentAnalysis.value = JSON.parse(data.candidates[0].content.parts[0].text);
                        isNewItem.value = true;
                        showResultModal.value = true;
                    } catch (err) {
                        alert("分析失败，请检查 API Key 或网络状况。");
                    } finally { loading.value = false; }
                };

                const saveToWardrobe = () => {
                    wardrobe.value.unshift({ 
                        id: Date.now(), 
                        name: newItem.value.name, 
                        itemImage: newItem.value.itemImage, 
                        analysis: currentAnalysis.value 
                    });
                    localStorage.setItem('smart_wardrobe_v2', JSON.stringify(wardrobe.value));
                    goHome(); 
                    showResultModal.value = false;
                };

                const showDetail = (item) => { 
                    selectedItem.value = item; 
                    currentAnalysis.value = item.analysis; 
                    isNewItem.value = false; 
                    showResultModal.value = true; 
                };

                const deleteItem = () => {
                    if (!selectedItem.value) return;
                    if (confirm(`确定要移除 "${selectedItem.value.name}" 吗？`)) {
                        wardrobe.value = wardrobe.value.filter(i => i.id !== selectedItem.value.id);
                        localStorage.setItem('smart_wardrobe_v2', JSON.stringify(wardrobe.value));
                        showResultModal.value = false;
                    }
                };

                const closeResult = () => { showResultModal.value = false; selectedItem.value = null; };

                const isReadyToAnalyze = computed(() => newItem.value.name && newItem.value.itemImage && newItem.value.labelImages.length > 0);

                return {
                    wardrobe, currentView, newItem, loading, showResultModal, currentAnalysis, isNewItem, isReadyToAnalyze, selectedItem,
                    showSettings, tempApiKey, apiKey,
                    itemImageInput, labelImageInput, editImageInput,
                    getIcon, goHome, goAdd, handleFile, triggerFile, startAnalysis, saveToWardrobe, showDetail, closeResult, saveSettings, deleteItem
                };
            }
        }).mount('#app');
    </script>
</body>
</html>